

=== FILE: ./__init__.py ===
from . import models,controllers

=== FILE: ./static/src/html/index.xml ===
<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <template id="meeting_rooms_html" name="Meeting Rooms HTML">
        <t t-name="meeting_rooms.meeting_rooms_html">
            <html lang="en">
                <head>
                    <meta charset="utf-8"/>
                    <meta name="viewport" content="width=device-width, initial-scale=1"/>
                    <title>Meeting Rooms Create Calendar</title>

                    <!-- IMPORTANT: jangan self-closing untuk script -->
                    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
                    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
                    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

                    <!-- CSS: jangan pakai text/scss langsung -->
                    <link rel="stylesheet" href="/meeting_rooms/static/src/css/index.css"/>
                    
                    <!-- Module JS -->
                    <script type="text/javascript" src="/meeting_rooms/static/src/js/index.js"></script>
                </head>

                <body>
                    <!-- Debug marker: kalau ini tampil, berarti halaman kebuka -->
                    <div style="font-family: Arial, sans-serif; font-size: 12px; padding: 10px; color: #555;">
                        Generating calendar invitation...
                    </div>

                    <!-- Debug marker in console -->
                    <script type="text/javascript">
                        console.log("[meeting_rooms] /create-icalendar page loaded");
                    </script>

                    <input type="hidden" id="start_date" t-att-value="start_date"/>
                    <input type="hidden" id="end_date" t-att-value="end_date"/>
                    <input type="hidden" id="subject" t-att-value="docs.subject"/>
                    <input type="hidden" id="room_location" t-att-value="docs.room_location.name"/>
                    <input type="hidden" id="description" t-att-value="docs.description"/>
                    <input type="hidden" id="reminder" t-att-value="docs.calendar_alarm.duration"/>
                    <input type="hidden" id="attendee" t-att-value="attendee"/>
                    <input type="hidden" id="user_email" t-att-value="request.env.user.email"/>
                    <input type="hidden" id="user_name" t-att-value="request.env.user.display_name"/>
                    <input type="hidden" id="meeting_id" t-att-value="docs.id"/>
                    <input type="hidden" id="create_date" t-att-value="docs.create_date"/>
                    <input type="hidden" id="write_date" t-att-value="docs.write_date"/>
                    <input type="hidden" id="version" t-att-value="docs.version"/>
                    <input type="hidden" id="roomTZ" t-att-value="docs.room_location.tz"/>
                    <input type="hidden" id="tzOffset" t-att-value="docs.room_location.tz_offset"/>
                </body>
            </html>
        </t>
    </template>
</odoo>


=== FILE: ./__manifest__.py ===
{
    'name': "Meeting System",

    'summary': """
        Short (1 phrase/line) summary of the module's purpose, used as
        subtitle on modules listing or apps.openerp.com""",

    'tag': """
        Long tag of module's purpose
    """,

    'author': "Alam",
    'website': "https://www.alamkamajana.com",

    # Categories can be used to filter modules in modules listing
    # Check https://github.com/odoo/odoo/blob/13.0/odoo/addons/base/data/ir_module_category_data.xml
    # for the full list
    'category': 'Uncategorized',
    'version': '0.1',

    # any module necessary for this one to work correctly
    'depends': ['base', 'calendar', 'mail', 'contacts', 'website'],

    # always loaded
    'data': [
        'security/meeting_security.xml',
        'security/ir.model.access.csv',
        'views/view.xml',
        'views/virtual_room.xml',
        'views/meeting_event_view.xml',
        'views/booking_link_view.xml',
        'views/meeting_rooms_ext_view.xml',
        'static/src/html/index.xml',
        # 'data/data_sync.xml',
        'data/cron_job.xml',
        'views/portal_templates.xml',
    ],

}


=== FILE: ./views/booking_link_view.xml ===
<?xml version="1.0" encoding="utf-8"?>
<odoo>
    
    <record id="view_meeting_booking_link_form" model="ir.ui.view">
        <field name="name">meeting.booking.link.form</field>
        <field name="model">meeting.booking.link</field>
        <field name="arch" type="xml">
            <form>
                <header>
                    <button name="action_regenerate_token" 
                            string="Regenerate Token" 
                            type="object" 
                            confirm="Link lama akan mati. Lanjutkan?" 
                            class="btn-warning"
                            attrs="{'invisible': [('is_current_user', '=', False), ('is_admin', '=', False)]}"/>
                </header>
                <sheet>
                    <div class="oe_title">
                        <label for="name" class="oe_edit_only"/>
                        <h1><field name="name" placeholder="e.g. Link for VIP Clients"/></h1>
                    </div>
                    <group>
                        <field name="is_current_user" invisible="1"/>
                        <field name="is_admin" invisible="1"/>
                        <field name="create_date" invisible="1"/>
                        
                        <group>
                            <field name="user_id" 
                                attrs="{'readonly': [('is_admin', '=', False), ('create_date', '!=', False)]}" 
                                domain="[('share', '=', False)]"
                                options="{'no_create': True, 'no_open': True}"/>
                                
                            <field name="active" widget="boolean_toggle" 
                                attrs="{'readonly': [('is_current_user', '=', False), ('is_admin', '=', False)]}"/>
                        </group>
                        <group>
                            <field name="booking_url" widget="CopyClipboardChar" readonly="1"/>
                            <field name="token" groups="base.group_no_one"/>
                        </group>
                    </group>
                    
                    <div class="alert alert-info" role="alert" attrs="{'invisible': [('is_current_user', '=', False), ('is_admin', '=', False)]}">
                        Ini link booking aktif. Share kepada tamu.
                    </div>
                    
                </sheet>
            </form>
        </field>
    </record>

    <record id="view_meeting_booking_link_kanban" model="ir.ui.view">
        <field name="name">meeting.booking.link.kanban</field>
        <field name="model">meeting.booking.link</field>
        <field name="arch" type="xml">
            <kanban class="o_kanban_mobile o_kanban_dashboard">
                <field name="name"/>
                <field name="user_id"/>
                <field name="booking_url"/>
                <field name="active"/>
                <field name="is_current_user"/>
                <field name="is_admin"/> 
                <templates>
                    <t t-name="kanban-box">
                        <t t-if="record.is_current_user.raw_value or record.is_admin.raw_value">
                            <div class="oe_kanban_global_click oe_kanban_card p-3">
                                <t t-call="kanban-content"/>
                            </div>
                        </t>
                        
                        <t t-else="">
                            <div class="oe_kanban_card p-3" style="cursor: default;">
                                <t t-call="kanban-content"/>
                            </div>
                        </t>
                    </t>

                    <t t-name="kanban-content">
                        <div class="d-flex flex-column h-100">
                            <div class="mb-2 d-flex justify-content-between align-items-start">
                                <div class="text-truncate pr-2">
                                    <strong style="font-size: 1.1em; color: #212529;">
                                        <field name="name"/>
                                    </strong>
                                    <div class="text-muted small mt-1">
                                        <i class="fa fa-user-circle mr-1"/> <field name="user_id"/>
                                    </div>
                                </div>
                                <t t-if="record.is_current_user.raw_value">
                                    <span class="badge badge-pill badge-info">My Link</span>
                                </t>
                            </div>

                            <div class="o_form_view my-3 w-100">
                                <div class="o_group">
                                    <field name="booking_url" widget="CopyClipboardChar" class="w-100"/>
                                </div>
                            </div>

                            <div class="mt-auto pt-2 border-top d-flex justify-content-between align-items-center">
                                <span class="text-muted small">Status Link</span>
                                <field name="active" widget="boolean_toggle" attrs="{'readonly': [('is_current_user', '=', False), ('is_admin', '=', False)]}"/>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <record id="action_meeting_booking_link" model="ir.actions.act_window">
        <field name="name">All Booking Links</field>
        <field name="res_model">meeting.booking.link</field>
        <field name="view_mode">kanban,tree,form</field> 
    </record>

    <record id="action_edit_my_booking_link_server" model="ir.actions.server">
        <field name="name">Edit My Booking Link</field>
        <field name="model_id" ref="model_meeting_booking_link"/>
        <field name="state">code</field>
        <field name="code">
            action = model.action_open_my_link()
        </field>
    </record>

    <menuitem id="menu_open_my_link"
              name="Edit My Booking Link"
              parent="menu_meeting_rooms"
              action="action_edit_my_booking_link_server"
              sequence="10"/>

    <menuitem id="menu_meeting_booking_link" 
              name="Booking Links List" 
              parent="menu_meeting_rooms" 
              action="action_meeting_booking_link" 
              sequence="20"/>

</odoo>

=== FILE: ./views/meeting_event_view.xml ===
<?xml version="1.0" encoding="UTF-8"?>
<odoo>

    <record id="meeting_event_calendar_view" model="ir.ui.view">
        <field name="name">meeting_event_calendar_view</field>
        <field name="model">meeting.event</field>
        <field name="arch" type="xml">
            <calendar string="Meeting Date"
                      date_start="start_date"
                      date_stop="end_date"
                      mode="day"
                      quick_add="False"
                      color="state">
                <field name="room_location_ids"/>
                <field name="subject"/>
                <field name="start_date"/>
                <field name="end_date"/>
                <field name="attendee"/>
                <field name="state"/>
            </calendar>
        </field>
    </record>

    <record id="meeting_event_tree_view" model="ir.ui.view">
        <field name="name">meeting_event_tree_view</field>
        <field name="model">meeting.event</field>
        <field name="arch" type="xml">
            <tree string="Meeting Event">
                <field name="subject"/>
                <field name="room_location_ids" widget="many2many_tags"/>
                <field name="virtual_room_id" optional="show"/>
                <field name="start_date"/>
                <field name="end_date"/>
                <field name="attendee" widget="many2many_tags"/>
                <field name="state"/>
                <button name="unlink" string="Delete" class="btn-danger fa-trash-o" type="object"/>
            </tree>
        </field>
    </record>

    <record id="meeting_event_form_view" model="ir.ui.view">
        <field name="name">meeting_event_form_view</field>
        <field name="model">meeting.event</field>
        <field name="arch" type="xml">
            <form string="Meeting Event">
                <header>
                    <button name="action_confirm" 
                            type="object" 
                            states="draft" 
                            string="Confirm" 
                            class="btn-primary"/>
                    
                    <button name="action_generate_virtual_link" 
                            type="object" 
                            string="Generate Meeting Link" 
                            class="oe_highlight"
                            icon="fa-video-camera"
                            attrs="{'invisible': ['|', '|', ('virtual_room_id', '=', False), ('state', '!=', 'confirm'), ('zoom_id', '!=', False)]}"/>

                    <button name="action_get_ai_summary" 
                            type="object" 
                            string="Get AI Summary" 
                            class="oe_highlight"
                            icon="fa-magic"
                            attrs="{'invisible': ['|', '|', ('virtual_room_id', '=', False), ('state', '!=', 'confirm'), ('zoom_id', '=', False)]}"/>

                    <button name="action_cancel" 
                            type="object" 
                            states="confirm" 
                            string="Cancel" 
                            class="btn-secondary"
                            confirm="PERINGATAN: Apakah Anda yakin ingin membatalkan Event ini? Tindakan ini akan otomatis membatalkan SEMUA Meeting Room yang terhubung."/>

                    <button name="action_draft" 
                            type="object" 
                            states="cancel" 
                            string="Set To Draft" 
                            class="btn-secondary"
                            confirm="PERINGATAN: Mengubah Event menjadi Draft akan mengubah status SEMUA Meeting Room menjadi Draft juga. Lanjutkan?"/>
                            
                    <field name="state" widget="statusbar" statusbar_visible="draft,confirm,cancel"/>
                </header>

                <sheet>
                    <group>
                        <group>
                            <field name="subject" required="1"/>
                            <field name="room_location_ids" widget="many2many_tags"/>

                            <field name="guest_partner_id" widget="res_partner_many2one" context="{'show_email': True}"/>
                            
                            <field name="virtual_room_id" 
                                   widget="selection" 
                                   string="Virtual Room Provider" 
                                   placeholder="Leave empty for offline meeting"/>
                            
                            <field name="description"/>
                            <field name="calendar_alarm"
                                   domain="[('interval','=','minutes'),('alarm_type','=','notification')]"
                                   widget="selection"/>
                            <field name="recurrency"/>
                        </group>

                        <group>
                            <field name="start_date"/>
                            <field name="end_date"/>
                            <field name="attendee"
                                   options="{'no_create_edit': True,'no_create': True}"
                                   widget="many2many_tags"
                                   domain="[('login','ilike','@Tripper.com'),('id','!=',uid)]"/>
                            <button name="create_calendar_web" type="object" string="Send Email &amp; Download ICS"/>
                        </group>
                    </group>

                    <group>
                        <field name="create_uid" string="Initiator"/>
                        <field name="create_date" string="Create Date"/>
                    </group>

                    <notebook>
                        <page string="Room Bookings">
                            <field name="meeting_room_ids">
                                <tree string="Generated Bookings" 
                                      decoration-danger="state=='cancel'" 
                                      decoration-info="state=='draft'" 
                                      decoration-success="state=='confirm'">
                                    <field name="room_location"/>
                                    <field name="start_date"/>
                                    <field name="end_date"/>
                                    <field name="state" widget="badge"/>
                                </tree>
                            </field>
                        </page>

                        <page string="Virtual Meeting Info" attrs="{'invisible': [('zoom_id', '=', False)]}">
                            
                            <group string="Connection Details">
                                <group>
                                    <field name="zoom_id" string="Meeting ID" readonly="1" class="oe_inline" style="font-weight: bold; font-size: 1.2em;"/>
                                </group>
                                <group>
                                    <field name="zoom_link" widget="url" string="Join URL"/>
                                    <field name="zoom_start_url" widget="url" string="Start URL (Host Only)" groups="base.group_system"/>
                                </group>
                            </group>

                            <separator string="Invitation Details"/>
                            <p class="text-muted">
                                Copy text below to send via WhatsApp or Email manually.
                            </p>
                            <field name="zoom_invitation" nolabel="1" style="background-color: #f9f9f9; padding: 10px; border-radius: 5px; font-family: monospace;"/>

                            <separator string="AI Summary Result"/>
                            <field name="ai_summary"/>
                        </page>

                        <page attrs="{'invisible': [('recurrency', '=', False)]}" string="Recurrence">
                            <group>
                                <group>
                                    <field name="rrule_type" attrs="{'required': [('recurrency', '=', True)]}"/>
                                </group>
                                <group>
                                    <field name="final_date" attrs="{'required': [('recurrency', '=', True)]}"/>
                                </group>
                            </group>
                        </page>

                        <page string="IT Settings" groups="base.group_system">
                            <group>
                                <group>
                                    <field name="version"/>
                                </group>
                                <group>
                                    <field name="calendar_file"/>
                                </group>
                            </group>
                        </page>
                    </notebook>
                </sheet>

                <div class="oe_chatter">
                    <field name="message_follower_ids" widget="mail_followers" groups="base.group_user"/>
                    <field name="message_ids" widget="mail_thread"/>
                    <field name="activity_ids" widget="mail_activity"/>
                </div>
            </form>
        </field>
    </record>

    <record model="ir.actions.act_window" id="action_meeting_event">
        <field name="name">Meeting Events</field>
        <field name="type">ir.actions.act_window</field>
        <field name="res_model">meeting.event</field>
        <field name="view_mode">calendar,tree,form</field>
    </record>

    <menuitem name="Meeting Events"
              id="menu_meeting_event"
              parent="meeting_rooms.menu_meeting_rooms"
              action="action_meeting_event"
              sequence="1"/> 

</odoo>

=== FILE: ./views/portal_templates.xml ===
<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="portal_booking_template" name="Booking Page">
        <t t-call="web.login_layout">
            <style>
                body { background-color: #f3f4f6; }
                .calendly-card {
                    background: white; border-radius: 8px;
                    box-shadow: 0 4px 25px rgba(0,0,0,0.05);
                    max-width: 1000px; margin: 50px auto; min-height: 600px;
                }
                .time-slot-btn {
                    display: block; width: 100%; text-align: center; padding: 10px 0;
                    margin-bottom: 10px; border: 1px solid #3b82f6; color: #3b82f6;
                    border-radius: 4px; font-weight: 600; text-decoration: none;
                }
                .time-slot-btn:hover {
                    background-color: #3b82f6; color: white;
                }
            </style>

            <div class="container-fluid">
                <div class="calendly-card">
                    <div class="row h-100 g-0">
                        <div class="col-md-4 p-5 border-right text-center">
                            <img t-attf-src="/book/avatar/#{token}" 
                                 style="width:80px; height:80px; border-radius:50%; object-fit: cover;" 
                                 alt="Host"/>
                            
                            <h4 class="mt-3"><t t-esc="host.name"/></h4>
                            <p class="text-muted">60 Min Meeting</p>
                        </div>
                        <div class="col-md-8 p-5">
                            <h3 class="font-weight-bold mb-4">Select Date &amp; Time (Asia/Singapore)</h3>
                            <div class="row">
                                <t t-foreach="dates" t-as="day">
                                    <div class="col-md-4 mb-4">
                                        <div class="text-center font-weight-bold mb-2">
                                            <t t-esc="day['date_str']"/>
                                        </div>
                                        <t t-foreach="day['slots']" t-as="slot">
                                            <a t-attf-href="/booking/details?token=#{token}&amp;time_str=#{slot['val']}" 
                                               class="time-slot-btn">
                                                <t t-esc="slot['time_str']"/>
                                            </a>
                                        </t>
                                        <t t-if="not day['slots']">
                                            <div class="text-center small text-muted">No slots</div>
                                        </t>
                                    </div>
                                </t>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </t>
    </template>

    <template id="portal_booking_form_template" name="Booking Details">
        <t t-call="web.login_layout">
            <div class="container mt-5">
                <div class="card shadow-sm" style="max-width: 600px; margin: 0 auto;">
                    <div class="card-body p-4">
                        <h4 class="mb-4">Enter Meeting Details</h4>
                        <form action="/booking/submit" method="POST">
                            <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                            <input type="hidden" name="token" t-att-value="token"/>
                            
                            <input type="hidden" name="time_str" t-att-value="time_str"/>
                            
                            <div class="form-group">
                                <label class="font-weight-bold text-muted small">Selected Time</label>
                                <input type="text" class="form-control" readonly="readonly" t-att-value="display_time" 
                                       style="background-color: #e9ecef; font-weight:bold; color:#2c3e50;"/>
                            </div>

                            <div class="form-group">
                                <label class="font-weight-bold text-muted small">Your Name</label>
                                <input type="text" name="name" class="form-control" required="required" t-att-value="default_name" placeholder="John Doe"/>
                            </div>

                            <div class="form-group">
                                <label class="font-weight-bold text-muted small">Your Email</label>
                                <input type="email" name="email" class="form-control" required="required" t-att-value="default_email" placeholder="john@example.com"/>
                            </div>

                            <div class="form-group">
                                <label class="font-weight-bold text-muted small">Topic / Subject (Optional)</label>
                                <input type="text" name="subject" class="form-control" placeholder="e.g. Project Discussion"/>
                            </div>
                            
                            <div class="mt-4">
                                <button type="submit" class="btn btn-primary btn-block" style="background-color: #00A09D; border: none; padding: 12px; font-weight:bold;">
                                    Confirm Booking
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </t>
    </template>
</odoo>

=== FILE: ./views/view.xml ===
<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <record id="mail_act_meeting_rooms_approval" model="mail.activity.type">
        <field name="name">Meeting Rooms</field>
        <field name="icon">fa-sun-o</field>
        <field name="res_model_id" ref="meeting_rooms.model_meeting_rooms"/>
    </record>

    <record id="meeting_rooms_calendar_view" model="ir.ui.view">
        <field name="name">meeting_rooms_calendar_view</field>
        <field name="model">meeting.rooms</field>
        <field name="arch" type="xml">
            <calendar string="Meeting Date" 
                      date_start="start_date" 
                      date_stop="end_date" 
                      mode="day" 
                      quick_add="False" 
                      event_open_popup="False"
                      color="room_location">
                <field name="room_location"/>
                <field name="subject"/>
                <field name="start_date"/>
                <field name="end_date"/>
                <field name="attendee"/>
                <field name="state"/>
            </calendar>
        </field>
    </record>

    <record id="meeting_rooms_tree_view" model="ir.ui.view">
        <field name="name">meeting_rooms_tree_view</field>
        <field name="model">meeting.rooms</field>
        <field name="arch" type="xml">
            <tree string="Meeting Room Booking" create="0" delete="0" edit="0">
                <field name="subject"/>
                <field name="room_location"/>
                <field name="start_date"/>
                <field name="end_date"/>
                <field name="attendee" widget="many2many_tags"/>
                <field name="description"/>
                <field name="state"/>
            </tree>
        </field>
    </record>

    <record id="meeting_rooms_from_view" model="ir.ui.view">
        <field name="name">meeting_rooms_from_view</field>
        <field name="model">meeting.rooms</field>
        <field name="arch" type="xml">
            <form string="Meeting Rooms Booking" create="0" delete="0" edit="0">
                <header>
                    <field name="state" widget="statusbar" statusbar_visible="draft,confirm,cancel"/>
                </header>
                <sheet>
                    <group>
                        <group>
                            <field name="subject"/>
                            <field name="room_location" widget="selection"/>
                            <field name="description"/>
                            <field name="calendar_alarm" widget="selection"/>
                            <field name="recurrency"/>
                        </group>
                        <group>
                            <field name="start_date"/>
                            <field name="end_date"/>
                            <field name="attendee" widget="many2many_tags"/>
                            <button name="create_calendar_web" type="object" string="Send Email"/>
                        </group>
                    </group>
                    <group>
                        <field name="create_uid" string="Initiator"/>
                        <field name="create_date" string="Create Date"/>
                    </group>
                    <notebook>
                        <page attrs="{'invisible': [('recurrency', '=', False)]}" string="Reccurent">
                            <group>
                                <field name="rrule_type"/>
                            </group>
                            <group>
                                <field name="final_date"/>
                            </group>
                        </page>
                        <page string="IT Settings" groups="base.group_system">
                            <group>
                                <field name="version"/>
                                <field name="calendar_file"/>
                            </group>
                        </page>
                    </notebook>
                </sheet>
                <div class="oe_chatter">
                    <field name="message_follower_ids" widget="mail_followers" groups="base.group_user"/>
                    <field name="message_ids" widget="mail_thread"/>
                    <field name="activity_ids" widget="mail_activity"/>
                </div>
            </form>
        </field>
    </record>

    <record id="room_location_form_view" model="ir.ui.view">
        <field name="name">room.location.form.view</field>
        <field name="model">room.location</field>
        <field name="arch" type="xml">
            <form string="Room Booking">
                <sheet>
                    <group>
                        <group>
                            <field name="name"/>
                            <field name="location_address"/>
                            <field name="location_description"/>
                            <field name="active"/>
                        </group>
                    </group>
                </sheet>
            </form>
        </field>
    </record>

    <record id="room_location_tree_view" model="ir.ui.view">
        <field name="name">room_location.tree.view</field>
        <field name="model">room.location</field>
        <field name="arch" type="xml">
            <tree string="Room Locations">
                <field name="name"/>
                <field name="location_address"/>
                <field name="location_description"/>
            </tree>
        </field>
    </record>

    <record model="ir.actions.act_window" id="action_room_location">
        <field name="name">Room Locations</field>
        <field name="type">ir.actions.act_window</field>
        <field name="res_model">room.location</field>
        <field name="view_mode">tree,form</field>
    </record>

    <record model="ir.actions.act_window" id="action_meeting_rooms_readonly_final">
        <field name="name">Booked Rooms (Read Only)</field>
        <field name="type">ir.actions.act_window</field>
        <field name="res_model">meeting.rooms</field>
        <field name="view_mode">calendar,tree,form</field>
        <field name="context">{'create': False, 'delete': False, 'edit': False, 'no_quick_create': True}</field>
    </record>


    <menuitem name="Meeting System" id="menu_meeting_rooms" sequence="60"/>
    <record id="menu_meeting_rooms" model="ir.ui.menu">
        <field name="action" eval="False"/>
    </record>

    <menuitem name="Booked Rooms List" 
              id="menu_meeting_rooms_list_readonly" 
              parent="menu_meeting_rooms" 
              action="action_meeting_rooms_readonly_final" 
              sequence="100"/>
              
    <menuitem name="Room Locations" id="menu_room_locations" parent="menu_meeting_rooms" action="action_room_location" groups="approvals.group_approval_user" sequence="110"/>
    <menuitem id="menu_meeting_booking_link" name="Booking Links List" parent="menu_meeting_rooms" action="action_meeting_booking_link" sequence="120"/>

</odoo>

=== FILE: ./views/meeting_rooms_ext_view.xml ===
<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <record id="meeting_rooms_form_ext_event" model="ir.ui.view">
        <field name="name">meeting.rooms.form.ext.event.link</field>
        <field name="model">meeting.rooms</field>
        <field name="inherit_id" ref="meeting_rooms.meeting_rooms_from_view"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='subject']" position="after">
                <field name="meeting_event_id" invisible="1"/>
            </xpath>
        </field>
    </record>
</odoo>

=== FILE: ./views/virtual_room.xml ===
<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <record id="view_virtual_room_form" model="ir.ui.view">
        <field name="name">virtual.room.form</field>
        <field name="model">virtual.room</field>
        <field name="arch" type="xml">
            <form string="Virtual Room Configuration">
                <header>
                    <button name="action_test_connection" 
                            string="Test API Connection" 
                            type="object" 
                            class="btn-secondary" 
                            icon="fa-plug"
                            attrs="{'invisible': [('provider', '=', 'google_meet')]}"/>
                </header>
                
                <sheet>
                    <div class="oe_title">
                        <label for="name" class="oe_edit_only"/>
                        <h1><field name="name" placeholder="e.g. Official Zoom Account"/></h1>
                    </div>
                    <group>
                        <group>
                            <field name="active"/>
                            <field name="provider" widget="radio"/> 
                            <field name="email" placeholder="host@company.com"/>
                        </group>
                        
                        <group string="Static Link Configuration" attrs="{'invisible': [('provider', '!=', 'google_meet')]}">
                            <field name="static_link" widget="url" attrs="{'required': [('provider', '=', 'google_meet')]}"/>
                            <div class="text-muted" colspan="2">
                                Paste link Google Meet permanen Anda di sini (contoh: https://meet.google.com/abc-defg-hij).
                            </div>
                        </group>

                        <group string="API Credentials" attrs="{'invisible': [('provider', '=', 'google_meet')]}">
                            <field name="zoom_account_id" string="Account ID (Zoom) / Tenant ID (Teams)" attrs="{'required': [('provider', '!=', 'google_meet')]}"/>
                            <field name="zoom_client_id" string="Client ID" attrs="{'required': [('provider', '!=', 'google_meet')]}"/>
                            <field name="zoom_client_secret" string="Client Secret" password="True" attrs="{'required': [('provider', '!=', 'google_meet')]}"/>
                        </group>
                    </group>
                </sheet>
            </form>
        </field>
    </record>

    <record id="view_virtual_room_tree" model="ir.ui.view">
        <field name="name">virtual.room.tree</field>
        <field name="model">virtual.room</field>
        <field name="arch" type="xml">
            <tree string="Virtual Rooms">
                <field name="name"/>
                <field name="provider"/>
                <field name="email"/>
                <field name="active"/>
            </tree>
        </field>
    </record>

    <record id="action_virtual_room" model="ir.actions.act_window">
        <field name="name">Virtual Room Accounts</field>
        <field name="res_model">virtual.room</field>
        <field name="view_mode">tree,form</field>
    </record>

    <menuitem id="menu_virtual_room" 
              name="Virtual Rooms" 
              parent="menu_meeting_rooms" 
              action="action_virtual_room" 
              sequence="30"/>
</odoo>

=== FILE: ./data/data_sync.xml ===
<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data noupdate="0">
        <function model="meeting.rooms" name="action_sync_legacy_data"/>
    </data>
</odoo>

=== FILE: ./data/cron_job.xml ===
<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data noupdate="1">
        <record id="ir_cron_auto_delete_meeting_activities" model="ir.cron">
            <field name="name">Auto Delete Meeting Activities</field>
            <field name="model_id" ref="model_meeting_event"/>
            <field name="state">code</field>
            <field name="code">model._cron_auto_delete_activities()</field>
            <field name="user_id" ref="base.user_root"/>
            <field name="interval_number">1</field>
            <field name="interval_type">days</field>
            <field name="numbercall">-1</field> <field name="doall" eval="False"/>
            <field name="priority">5</field>
        </record>
    </data>
</odoo>

=== FILE: ./controllers/website.py ===
# -*- coding: utf-8 -*-
from datetime import datetime,date,timedelta
import json
from werkzeug.utils import redirect
from odoo import http
from odoo.http import request
import pytz
import base64


class MeetingRoomsWebsite(http.Controller):
    @http.route('/create-icalendar', auth='user', website=True)
    def create_icalendar(self, **kw):
        meeting_id = kw.get('id')
        meeting = request.env['meeting.rooms'].sudo().browse(int(meeting_id))
        attendee = []
        tz = pytz.timezone(meeting.room_location.tz or "Asia/Singapore")
        current_offset = datetime.now(pytz.utc).astimezone(tz).utcoffset()
        offset_hours = current_offset.total_seconds() / 3600
        start_time = meeting.start_date + timedelta(hours=offset_hours)
        end_time = meeting.end_date + timedelta(hours=offset_hours)
        create_time = meeting.create_date + timedelta(hours=offset_hours)
        write_time = meeting.write_date + timedelta(hours=offset_hours)
        for user in meeting.attendee :
            if user.display_name and user.email :
                attendee.append({
                    "name" : user.display_name,"email" : user.email
                })
        vals = {
            'docs' : meeting,
            'attendee' : attendee,
            'start_date' : start_time,
            'end_date' : end_time,
            'create_date' : create_time,
            'write_date' : write_time

        }
        return request.render("meeting_rooms.meeting_rooms_html", vals)

    @http.route('/add-icalendar-file', type='http', auth='user', website=True, csrf=False)
    def add_calendar_file(self, **kw):
        file = kw.get("calendar")
        file_name = kw.get("calendar_name")
        meeting_id = int(kw.get("meeting_id"))
        files = base64.b64encode(file.read())
        attachment = None
        attachment_calendar = request.env['ir.attachment'].sudo().search(
            [('res_model', '=', 'meeting.rooms'), ('type', '=', 'binary'), ('res_field', '=', 'calendar_file'),
             ('res_id', '=', meeting_id)])
        if attachment_calendar:
            attachment_calendar.unlink()
            attachment = request.env['ir.attachment'].sudo().create({
                'name': file_name,
                'type': 'binary',
                'res_model': 'meeting.rooms',
                'res_field': 'calendar_file',
                'res_id': meeting_id,
                'res_name': file_name,
                'datas': files,
                'public': True
            })
        else:
            attachment = request.env['ir.attachment'].sudo().create({
                'name': file_name,
                'type': 'binary',
                'res_model': 'meeting.rooms',
                'res_field': 'calendar_file',
                'res_id': meeting_id,
                'res_name': file_name,
                'datas': files,
                'public': True
            })
        record = request.env['meeting.rooms'].sudo().browse(meeting_id)
        tz = pytz.timezone(record.room_location.tz or "Asia/Singapore")
        current_offset = datetime.now(pytz.utc).astimezone(tz).utcoffset()
        offset_hours = current_offset.total_seconds() / 3600
        start_time = record.start_date + timedelta(hours=offset_hours)
        end_time = record.end_date + timedelta(hours=offset_hours)
        formatted_start_time = start_time.strftime('%b %d, %Y')
        start_time_hours = start_time.strftime('%H:%M')
        formatted_end_time = end_time.strftime('%b %d, %Y %H:%M')
        end_time_hours = end_time.strftime('%H:%M')
        duration = end_time - start_time
        meeting_hours, remainder = divmod(duration.total_seconds(), 3600)
        meeting_minutes, meeting_seconds = divmod(remainder, 60)
        meeting_hours_str = ""
        if meeting_hours > 0:
            meeting_hours_str = f"{int(meeting_hours)} hours "

        meeting_minutes_str = ""
        if meeting_minutes > 0:
            meeting_minutes_str = f"{int(meeting_minutes)} minutes"
        recipients = []
        recipients.append(record.create_uid.email)
        for user in record.attendee:
            recipients.append(user.email)
        recipients_email = ",".join(recipients)
        email_body = f"""
            Hi <b>Team</b>,<br/><br/>
            I hope this message finds you well. <b>{record.create_uid.name}</b> has invited you to the "{record.name}" meeting<br/><br/>
            <table border="0">
                <tbody>
                    <tr>
                        <td style="width:80px;">Date</td>
                        <td>: {formatted_start_time}</td>
                    </tr>
                    <tr>
                        <td>Time</td>
                        <td>: {start_time_hours} - {end_time_hours} ({record.room_location.tz}'s Time)</td>
                    </tr>
                    <tr>
                        <td>Duration</td>
                        <td>: {meeting_hours_str}{meeting_minutes_str}</td>
                    </tr>
                    <tr>
                        <td>Location</td>
                        <td>: {record.room_location.name}</td>
                    </tr>
                </tbody>
            </table>
            <br/>
            To accept or decline this invitation, click the attachment below.<br/><br/>
            """
        email = request.env['mail.mail'].sudo().create({
            'subject': record.subject,
            'email_from': 'odoo-erp@tripper.com',
            'email_to': recipients_email,
            'body_html': email_body

        })
        email.attachment_ids = attachment
        email.send()
        log = None
        if email.state == "sent":
            log = f"""
                    <b>Email Sent</b> <br/>
                    id : {email.id} <br/>
                    subject : {email.subject} <br/>
                    email to : {recipients_email} <br/>
                    body : {email.body_html} 

                """
        elif email.state == "exception":
            log = f"Email {email.id} Delivery Failed"
        else:
            log = f"Email Delivery {email.state}"
        record.message_post(body=log)
        data = {'url': attachment.local_url}
        return json.dumps(data)


=== FILE: ./controllers/booking_portal.py ===
# -*- coding: utf-8 -*-
from odoo import http, fields, _
from odoo.http import request
from datetime import datetime, timedelta, time
import pytz
import base64  

class BookingPortal(http.Controller):

    # =========================================================================
    # 0. KHUSUS: MENAMPILKAN AVATAR HOST (BYPASS SECURITY)
    # =========================================================================
    @http.route('/book/avatar/<string:token>', type='http', auth='public')
    def booking_avatar(self, token):
        # 1. Cek Token Valid (Pakai Sudo agar publik bisa akses)
        link_obj = request.env['meeting.booking.link'].sudo().search([('token', '=', token)], limit=1)
        
        if not link_obj:
            return request.not_found()
            
        # 2. Ambil Gambar dari Partner Host
        partner = link_obj.user_id.partner_id
        if not partner.image_128:
            # Jika tidak ada foto, redirect ke placeholder bawaan Odoo
            return request.redirect('/web/static/img/placeholder.png')
            
        # 3. Decode Gambar & Return sebagai Response HTTP
        image_data = base64.b64decode(partner.image_128)
        headers = [
            ('Content-Type', 'image/png'), 
            ('Content-Length', len(image_data)),
            ('Cache-Control', 'max-age=3600, public')
        ]
        return request.make_response(image_data, headers)

    # =========================================================================
    # 1. HALAMAN KALENDER (PEMILIHAN SLOT)
    # =========================================================================
    @http.route('/book/<string:token>', type='http', auth='public', website=True)
    def booking_calendar(self, token, **kw):
        link_obj = request.env['meeting.booking.link'].sudo().search([
            ('token', '=', token),
            ('active', '=', True)
        ], limit=1)

        if not link_obj:
            return request.render('http_routing.404') 

        host_user = link_obj.user_id
        sg_tz = pytz.timezone('Asia/Singapore') 
        
        now_sg = datetime.now(sg_tz)
        dates = []
        
        MeetingEvent = request.env['meeting.event'].sudo()

        for i in range(6): 
            current_date = now_sg.date() + timedelta(days=i)
            day_slots = []
            
            for hour in range(9, 17): 
                start_dt_sg = sg_tz.localize(datetime.combine(current_date, time(hour, 0, 0)))
                
                if start_dt_sg < now_sg:
                    continue

                end_dt_sg = start_dt_sg + timedelta(hours=1)
                start_dt_utc = start_dt_sg.astimezone(pytz.utc).replace(tzinfo=None)
                end_dt_utc = end_dt_sg.astimezone(pytz.utc).replace(tzinfo=None)

                domain = [
                    ('start_date', '<', end_dt_utc),
                    ('end_date', '>', start_dt_utc),
                    ('state', '=', 'confirm'),
                    ('attendee', 'in', [host_user.id])
                ]
                count_busy = MeetingEvent.search_count(domain)

                if count_busy == 0:
                    day_slots.append({
                        'time_str': f"{hour:02d}:00", 
                        'val': start_dt_utc.strftime('%Y-%m-%d %H:%M:%S') 
                    })

            if day_slots:
                dates.append({
                    'date_str': current_date.strftime('%A, %d %b'),
                    'slots': day_slots
                })

        return request.render('meeting_rooms.portal_booking_template', {
            'host': host_user,
            'dates': dates,
            'token': token,
        })

    # =========================================================================
    # 2. HALAMAN FORM DETAILS (KONFIRMASI WAKTU)
    # =========================================================================
    @http.route('/booking/details', type='http', auth='public', website=True)
    def booking_details_form(self, token, time_str, **kw):
        link_obj = request.env['meeting.booking.link'].sudo().search([
            ('token', '=', token),
            ('active', '=', True)
        ], limit=1)

        if not link_obj:
            return "Token Invalid or Expired"
        
        host_user = link_obj.user_id
        
        try:
            dt_utc = datetime.strptime(time_str.strip(), '%Y-%m-%d %H:%M:%S')
            
            utc_zone = pytz.utc
            sg_zone = pytz.timezone('Asia/Singapore')
            
            dt_aware_utc = utc_zone.localize(dt_utc)
            dt_sg = dt_aware_utc.astimezone(sg_zone)
            
            pretty_time_str = dt_sg.strftime('%A, %d %b %Y - %H:%M (Asia/Singapore)')
            
            return request.render('meeting_rooms.portal_booking_form_template', {
                'host': host_user,
                'token': token,
                'time_str': time_str,
                'display_time': pretty_time_str,
                'default_name': request.env.user.name if not request.env.user._is_public() else '',
                'default_email': request.env.user.email if not request.env.user._is_public() else '',
            })
        except Exception as e:
            return f"Error parsing schedule: {str(e)}"

    # =========================================================================
    # 3. PROSES SUBMIT (DATABASE STORAGE)
    # =========================================================================
    @http.route('/booking/submit', type='http', auth='public', website=True, csrf=True)
    def booking_submit(self, token, time_str, **kw):
        booking_link = request.env['meeting.booking.link'].sudo().search([
            ('token', '=', token),
            ('active', '=', True)
        ], limit=1)
        
        if not booking_link:
            return "Link Not Found"

        name = kw.get('name', 'Guest')
        email = kw.get('email')
        subject_input = kw.get('subject')

        final_subject = subject_input if (subject_input and subject_input.strip()) else f"Meeting with {name}"

        try:
            start_dt = datetime.strptime(time_str.strip(), '%Y-%m-%d %H:%M:%S')
            end_dt = start_dt + timedelta(hours=1) 
        except ValueError:
            return "Format waktu tidak valid."

        host_user = booking_link.user_id

        Partner = request.env['res.partner'].sudo()
        guest_partner = Partner.search([('email', '=', email)], limit=1)
        if not guest_partner:
            guest_partner = Partner.create({'name': name, 'email': email, 'type': 'contact'})
        else:
            guest_partner.write({'name': name})

        domain = [
            ('start_date', '<', end_dt),
            ('end_date', '>', start_dt),
            ('attendee', 'in', [host_user.id]),
            ('state', '!=', 'cancel')
        ]
        conflict = request.env['meeting.event'].sudo().search(domain, limit=1)
        if conflict:
             return "Maaf, slot waktu ini baru saja dipesan oleh orang lain."

        new_event = request.env['meeting.event'].sudo().create({
            'subject': final_subject,
            'start_date': start_dt,
            'end_date': end_dt,
            'attendee': [(4, host_user.id)],
            'state': 'draft',
            'guest_partner_id': guest_partner.id,
        })

        try:
            if hasattr(new_event, 'action_send_invite_to_guest'):
                new_event.action_send_invite_to_guest(email)
        except:
            pass

        return f"""
            <div style='display:flex; justify-content:center; align-items:center; height:100vh; background-color:#f3f4f6; font-family:sans-serif;'>
                <div style='text-align:center; padding:40px; background:white; border-radius:10px; box-shadow:0 4px 15px rgba(0,0,0,0.1); max-width:550px;'>
                    <div style='color:#00A09D; font-size:60px; margin-bottom:20px;'></div>
                    <h1 style='color:#2c3e50; margin-bottom:15px;'>Booking Confirmed!</h1>
                    
                    <p style='color:#555; font-size:16px; line-height:1.5;'>
                        Thank you, <b>{name}</b>. A meeting invitation has been sent to <b>{email}</b>. 
                        <br/>Please check your inbox or spam folder.
                    </p>
                    
                    <div style='background-color:#e3f2fd; padding:15px; border-radius:5px; margin:25px 0; color:#0d47a1;'>
                        Host: <b>{host_user.name}</b>
                    </div>
                    <a href='/book/{token}' style='display:inline-block; padding:12px 25px; background-color:#00A09D; color:white; text-decoration:none; border-radius:5px; font-weight:bold;'>
                        Close / Book Another Slot
                    </a>
                </div>
            </div>
        """

=== FILE: ./controllers/__init__.py ===
from . import website
from . import booking_portal

=== FILE: ./security/meeting_security.xml ===
<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data noupdate="0">
        
        <record model="ir.module.category" id="module_category_meeting">
            <field name="name">Meeting System</field>
            <field name="description">Manage Meeting Rooms and Events</field>
            <field name="sequence">10</field>
        </record>

        <record id="group_meeting_user" model="res.groups">
            <field name="name">User</field>
            <field name="category_id" ref="module_category_meeting"/>
            <field name="implied_ids" eval="[(4, ref('base.group_user'))]"/>
        </record>

        <record id="group_meeting_manager" model="res.groups">
            <field name="name">Administrator</field>
            <field name="category_id" ref="module_category_meeting"/>
            <field name="implied_ids" eval="[(4, ref('meeting_rooms.group_meeting_user'))]"/>
            <field name="users" eval="[(4, ref('base.user_root')), (4, ref('base.user_admin'))]"/> 
        </record>

        <record id="rule_meeting_booking_link_read_all" model="ir.rule">
            <field name="name">Booking Link: Read All</field>
            <field name="model_id" ref="model_meeting_booking_link"/>
            <field name="domain_force">[(1, '=', 1)]</field> 
            <field name="groups" eval="[(4, ref('base.group_user'))]"/>
            <field name="perm_read" eval="True"/>
            <field name="perm_write" eval="False"/> <field name="perm_create" eval="False"/>
            <field name="perm_unlink" eval="False"/>
        </record>

        <record id="rule_meeting_booking_link_write_own" model="ir.rule">
            <field name="name">Booking Link: Edit Own Only</field>
            <field name="model_id" ref="model_meeting_booking_link"/>
            <field name="domain_force">[('user_id', '=', user.id)]</field> 
            <field name="groups" eval="[(4, ref('base.group_user'))]"/>
            <field name="perm_read" eval="False"/> <field name="perm_write" eval="True"/>
            <field name="perm_create" eval="True"/>
            <field name="perm_unlink" eval="True"/>
        </record>

        <record id="rule_meeting_booking_link_admin" model="ir.rule">
            <field name="name">Admin Edit All Booking Links</field>
            <field name="model_id" ref="model_meeting_booking_link"/>
            <field name="domain_force">[(1, '=', 1)]</field>
            <field name="groups" eval="[(4, ref('meeting_rooms.group_meeting_manager'))]"/> 
            <field name="perm_read" eval="True"/>
            <field name="perm_write" eval="True"/>
            <field name="perm_create" eval="True"/>
            <field name="perm_unlink" eval="True"/>
        </record>

        <record id="rule_meeting_event_read_all" model="ir.rule">
            <field name="name">Meeting Event: Read All</field>
            <field name="model_id" ref="model_meeting_event"/>
            <field name="domain_force">[(1, '=', 1)]</field>
            <field name="groups" eval="[(4, ref('base.group_user'))]"/>
            <field name="perm_read" eval="True"/>
            <field name="perm_write" eval="False"/>
            <field name="perm_create" eval="False"/>
            <field name="perm_unlink" eval="False"/>
        </record>

        <record id="rule_meeting_event_own" model="ir.rule">
            <field name="name">Meeting Event: Manage Own</field>
            <field name="model_id" ref="model_meeting_event"/>
            <field name="domain_force">[('create_uid', '=', user.id)]</field>
            <field name="groups" eval="[(4, ref('base.group_user'))]"/>
            <field name="perm_read" eval="False"/>
            <field name="perm_write" eval="True"/>
            <field name="perm_create" eval="True"/>
            <field name="perm_unlink" eval="True"/>
        </record>

        <record id="rule_meeting_event_admin" model="ir.rule">
            <field name="name">Meeting Event: Admin Full</field>
            <field name="model_id" ref="model_meeting_event"/>
            <field name="domain_force">[(1, '=', 1)]</field>
            <field name="groups" eval="[(4, ref('meeting_rooms.group_meeting_manager'))]"/>
            <field name="perm_read" eval="True"/>
            <field name="perm_write" eval="True"/>
            <field name="perm_create" eval="True"/>
            <field name="perm_unlink" eval="True"/>
        </record>

        <record id="rule_meeting_rooms_read_all" model="ir.rule">
            <field name="name">Meeting Rooms: Read All</field>
            <field name="model_id" ref="model_meeting_rooms"/>
            <field name="domain_force">[(1, '=', 1)]</field>
            <field name="groups" eval="[(4, ref('base.group_user'))]"/>
            <field name="perm_read" eval="True"/>
            <field name="perm_write" eval="False"/>
            <field name="perm_create" eval="False"/>
            <field name="perm_unlink" eval="False"/>
        </record>

        <record id="rule_meeting_rooms_own" model="ir.rule">
            <field name="name">Meeting Rooms: Manage Own</field>
            <field name="model_id" ref="model_meeting_rooms"/>
            <field name="domain_force">[('create_uid', '=', user.id)]</field>
            <field name="groups" eval="[(4, ref('base.group_user'))]"/>
            <field name="perm_read" eval="False"/>
            <field name="perm_write" eval="True"/>
            <field name="perm_create" eval="True"/>
            <field name="perm_unlink" eval="True"/>
        </record>

        <record id="rule_meeting_rooms_admin" model="ir.rule">
            <field name="name">Meeting Rooms: Admin Full</field>
            <field name="model_id" ref="model_meeting_rooms"/>
            <field name="domain_force">[(1, '=', 1)]</field>
            <field name="groups" eval="[(4, ref('meeting_rooms.group_meeting_manager'))]"/>
            <field name="perm_read" eval="True"/>
            <field name="perm_write" eval="True"/>
            <field name="perm_create" eval="True"/>
            <field name="perm_unlink" eval="True"/>
        </record>

    </data>
</odoo>

=== FILE: ./security/ir.model.access.csv ===
id,name,model_id:id,group_id:id,perm_read,perm_write,perm_create,perm_unlink
access_meeting_rooms,access_meeting_rooms,model_meeting_rooms,base.group_user,1,1,1,1
access_room_location,access_room_location,model_room_location,base.group_user,1,1,1,1
access_meeting_event,access_meeting_event,model_meeting_event,base.group_user,1,1,1,1
access_virtual_room_user,virtual.room user,model_virtual_room,base.group_user,1,1,1,0
access_meeting_booking_link_user,meeting.booking.link.user,model_meeting_booking_link,base.group_user,1,1,0,1
access_meeting_booking_link_portal,meeting.booking.link.portal,model_meeting_booking_link,base.group_portal,1,0,0,0
access_meeting_booking_link_manager,meeting.booking.link.manager,model_meeting_booking_link,base.group_system,1,1,1,1
access_meeting_rooms_mgr,meeting_rooms_mgr,model_meeting_rooms,meeting_rooms.group_meeting_manager,1,1,1,1
access_room_location_mgr,room_location_mgr,model_room_location,meeting_rooms.group_meeting_manager,1,1,1,1
access_meeting_event_mgr,meeting_event_mgr,model_meeting_event,meeting_rooms.group_meeting_manager,1,1,1,1
access_virtual_room_mgr,virtual_room_mgr,model_virtual_room,meeting_rooms.group_meeting_manager,1,1,1,1
access_meeting_booking_link_mgr_new,booking_link_mgr_new,model_meeting_booking_link,meeting_rooms.group_meeting_manager,1,1,1,1

=== FILE: ./models/__init__.py ===
from . import model
from . import meeting_event
from . import meeting_rooms_ext
from . import virtual_room
from . import booking_link

=== FILE: ./models/model.py ===
from odoo import fields, models, api, _
from datetime import datetime, timedelta, date
from odoo.exceptions import AccessDenied, UserError
import pytz
import subprocess
import base64

# put POSIX 'Etc/*' entries at the end to avoid confusing users - see bug 1086728
_tzs = [(tz, tz) for tz in sorted(pytz.all_timezones, key=lambda tz: tz if not tz.startswith('Etc/') else '_')]
def _tz_get(self):
    return _tzs

class MeetingRoomsLocation(models.Model):
    _name = 'room.location'
    _description = 'Meeting Room Location'

    name = fields.Char("Location")
    active = fields.Boolean("active ?", default=True)
    location_address = fields.Text("Address")
    location_description = fields.Text("Description")
    tz = fields.Selection(_tz_get, string='Timezone', default=lambda self: self._context.get('tz'),
                          help="When printing documents and exporting/importing data, time values are computed according to this timezone.\n"
                               "If the timezone is not set, UTC (Coordinated Universal Time) is used.\n"
                               "Anywhere else, time values are computed according to the time offset of your web client.")
    tz_offset = fields.Char("Offset", compute = '_compute_offset')

    def _compute_offset(self):
        for record in self:
            timezone = record.tz or 'UTC'  # Default to UTC if no timezone is set

            time_zone = pytz.timezone(timezone)
            current_time = datetime.now(pytz.utc).astimezone(time_zone)

            timezone_offset = current_time.utcoffset().total_seconds() / 60

            offset_hours = int(timezone_offset // 60)
            offset_minutes = int(abs(timezone_offset) % 60)

            # Format the offset (e.g., +08:00, -05:30, etc.)
            record.tz_offset = f"{'+' if offset_hours >= 0 else '-'}{abs(offset_hours):02d}{abs(offset_minutes):02d}"


class MeetingRooms(models.Model):
    _inherit = ['mail.thread', 'mail.activity.mixin']
    _name = 'meeting.rooms'
    _description = 'Meeting Rooms Booking'

    name = fields.Char("Name")
    subject = fields.Char("Subject")
    room_location = fields.Many2one("room.location", string="Location", required=True)
    start_date = fields.Datetime("Start", required=True)
    end_date = fields.Datetime("End", required=True)
    attendee = fields.Many2many("res.users", string="Attendee")
    description = fields.Text("Description")
    calendar_alarm = fields.Many2one("calendar.alarm", string="Reminder", required=True)
    state = fields.Selection([('draft', 'Draft'),
                              ('confirm', 'Confirm'),('cancel','Cancelled')], string='Status',tracking=True, copy=False,default='confirm')
    recurrency = fields.Boolean('Recurrent', help="Recurrent Meeting")
    rrule_type = fields.Selection([
        ('daily', 'Daily'),
        ('weekly', 'Weekly')
    ], string='Recurrence', help="Let the event automatically repeat at that interval")
    final_date = fields.Date('Repeat Until')
    action = fields.Boolean("Action")
    email_sent = fields.Boolean("Email Sent?")
    version = fields.Integer("Version", default=1)
    calendar_file = fields.Binary(string="Calendar File")
    
    virtual_room_id = fields.Many2one('virtual.room', string="Virtual Room")

    # =========================================================================
    # FUNGSI SECURITY (GEMBOK)
    # =========================================================================
    def _check_readonly_access(self):
        if self.env.context.get('bypass_security_check'):
            return True
            
        raise UserError(_(
            "AKSES DITOLAK!\n\n"
            "Anda tidak bisa membuat, mengedit, atau menghapus Booking secara manual di menu ini.\n"
            "Silakan pergi ke menu 'Meeting Events' untuk mengatur jadwal."
        ))

    def send_email_meeting(self):
        for rec in self :
            tz = pytz.timezone(rec.room_location.tz or "Asia/Singapore")
            current_offset = datetime.now(pytz.utc).astimezone(tz).utcoffset()
            offset_hours = current_offset.total_seconds() / 3600
            start_time = rec.start_date + timedelta(hours=offset_hours)
            end_time = rec.end_date + timedelta(hours=offset_hours)
            create_time = rec.create_date + timedelta(hours=offset_hours)
            write_time = rec.write_date + timedelta(hours=offset_hours)
            reminder = int(rec.calendar_alarm.duration) if rec.calendar_alarm.duration else 1
            attendee_str = ''
            for user in rec.attendee :
                attendee_str += f'ATTENDEE;ROLE=REQ-PARTICIPANT;RSVP=TRUE;CN="{user.display_name}":mailto:{user.email}'
                if user != rec.attendee[-1]:
                    attendee_str += '\n'
            icsContent = f"""BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//ZContent.net//Zap Calendar 1.0//EN
CALSCALE:GREGORIAN
METHOD:REQUEST

BEGIN:VTIMEZONE
TZID:{rec.room_location.tz}
X-LIC-LOCATION:${rec.room_location.tz}
BEGIN:STANDARD
DTSTART:19700101T000000
TZOFFSETFROM:{rec.room_location.tz_offset}
TZOFFSETTO:{rec.room_location.tz_offset}
TZNAME:${rec.room_location.tz}
END:STANDARD
END:VTIMEZONE

BEGIN:VEVENT
UID:{rec.id}
SEQUENCE:{rec.version}
SUMMARY:{rec.subject}
DTSTAMP:{create_time}
LAST-MODIFIED:{write_time}
DTSTART;TZID={rec.room_location.tz}:{start_time}
DTEND;TZID={rec.room_location.tz}:{end_time}
LOCATION:{rec.room_location.name}
DESCRIPTION:{rec.description}
ORGANIZER;PARTSTAT=ACCEPTED;CN="{rec.create_uid.display_name}":mailto:{rec.create_uid.email}
{attendee_str}
BEGIN:VALARM
TRIGGER:-PT${reminder}M
ACTION:DISPLAY
DESCRIPTION:Reminder
END:VALARM
END:VEVENT
END:VCALENDAR`;
            """
            filename = f"{rec.subject}.ics"
            with open(filename, 'w') as file:
                file.write(icsContent)

            with open(filename, 'rb') as file:
                attachment_calendar = self.env['ir.attachment'].sudo().search(
                    [('res_model', '=', 'meeting.rooms'), ('type', '=', 'binary'), ('res_field', '=', 'calendar_file'),('res_id', '=', rec.id)])
                if attachment_calendar:
                    attachment_calendar.unlink()
                    attachment = self.env['ir.attachment'].sudo().create({
                        'name': filename,
                        'type': 'binary',
                        'res_model': 'meeting.rooms',
                        'res_field': 'calendar_file',
                        'res_id': rec.id,
                        'res_name': filename,
                        'datas': base64.b64encode(file.read()),
                        'public': True
                    })
                else:
                    attachment = self.env['ir.attachment'].sudo().create({
                        'name': filename,
                        'type': 'binary',
                        'res_model': 'meeting.rooms',
                        'res_field': 'calendar_file',
                        'res_id': rec.id,
                        'res_name': filename,
                        'datas': base64.b64encode(file.read()),
                        'public': True
                    })



    def create_calendar_event(self):
        for rec in self :
            tz = pytz.timezone(rec.room_location.tz or "Asia/Singapore")
            current_offset = datetime.now(pytz.utc).astimezone(tz).utcoffset()
            offset_hours = current_offset.total_seconds() / 3600
            start_time = rec.start_date + timedelta(hours=offset_hours)
            end_time = rec.end_date + timedelta(hours=offset_hours)
            start_day = start_time.day
            start_month = start_time.month
            start_year = start_time.year
            start_hour = start_time.hour
            start_minute = start_time.minute
            start_second = start_time.second
            end_day = end_time.day
            end_month = end_time.month
            end_year = end_time.year
            end_hour = end_time.hour
            end_minute = end_time.minute
            end_second = end_time.second
            subject = rec.subject
            reminder = int(rec.calendar_alarm.duration) if rec.calendar_alarm.duration else 1
            description = rec.description if rec.description else None

            attendee = ''
            for user in self.attendee :
                if user.display_name and user.email :
                    attendee += 'make new attendee at beginning of attendees with properties {display name:"%s", email:"%s"}\n' %(user.display_name,user.email)

            applescript = """
        set theStartDate to (current date) 
        set year of theStartDate to %s
        set month of theStartDate to %s
        set day of theStartDate to %s
        set hours of theStartDate to %s
        set minutes of theStartDate to %s
        set seconds of theStartDate to %s
        set theEndDate to (current date) 
        set year of theEndDate to %s
        set month of theEndDate to %s
        set day of theEndDate to %s
        set hours of theEndDate to %s
        set minutes of theEndDate to %s
        set seconds of theEndDate to %s
        
        tell application "Calendar"
        activate
            tell calendar "Home"
                set new_event to make new event at end of events with properties {summary:"%s", start date:theStartDate, end date:theEndDate, location:"%s", description:"%s"}
            end tell
            tell new_event
                %s
            end tell
            tell new_event
                make new sound alarm at end of sound alarms with properties {trigger interval:-%s, sound name:"Sosumi"}
            end tell
        end tell
            """ % (start_year, start_month, start_day, start_hour, start_minute, start_second, end_year, end_month, end_day,
                   end_hour, end_minute, end_second, subject,rec.room_location.name,description,attendee,reminder)

            subprocess.run(['osascript', '-e', applescript])


    def run_calendar(self):
        for rec in self :
            self.create_calendar_event()

    def create_calendar_web(self):
        return {
            'name': "Create Calendar",
            'type': 'ir.actions.act_url',
            'url': f"/create-icalendar?id={self.id}",
            'target': 'new',
        }

    def action_confirm(self):
        for rec in self:
            rec.state = 'confirm'
            # SUDAH BERSIH DARI ACTIVITY

    def action_cancel(self):
        tz = pytz.timezone(self.room_location.tz or "Asia/Singapore")
        current_offset = datetime.now(pytz.utc).astimezone(tz).utcoffset()
        offset_hours = current_offset.total_seconds() / 3600
        for rec in self :
            start_time = rec.start_date + timedelta(hours=offset_hours)
            end_time = rec.end_date + timedelta(hours=offset_hours)
            rec.activity_feedback(['meeting_rooms.mail_act_meeting_rooms_approval'])
            group = []
            for user in rec.attendee :
                group.append(user.partner_id.id)
            value = {'partner_ids': group,
                     'channel_ids': [],
                     'body': f"Meeting {rec.subject} from {start_time} to {end_time} in {rec.room_location.name} Is Cancelled",
                     'attachment_ids': [],
                     'canned_response_ids': [],
                     'message_type': 'comment',
                     'subtype': 'mail.mt_note'}
            rec.message_post(**value)
            rec.state = 'cancel'

    def action_draft(self):
        self.state = 'draft'

    def unlink(self):
        self._check_readonly_access()
        is_manager = self.env.user.has_group('meeting_rooms.group_meeting_manager')
        if self.create_uid != self.env.user and not is_manager:
            raise AccessDenied(f"Only Initiator ({self.create_uid.name}) Or Meeting Administrator can delete")
        return super(MeetingRooms, self).unlink()

    @api.constrains('start_date', 'end_date', 'room_location')
    def _check_booking_validity(self):
        if self.env.context.get('skip_double_booking_check'):
            return

        tz = pytz.timezone(self.room_location.tz or "Asia/Singapore")
        current_offset = datetime.now(pytz.utc).astimezone(tz).utcoffset()
        offset_hours = current_offset.total_seconds() / 3600
        for record in self:
            if record.end_date <= record.start_date:
                raise AccessDenied(_("End Date cannot be in the past"))
            records = self.search([])
            for rec in records :
                if rec.id == record.id:
                    continue
                start_time = rec.start_date + timedelta(hours=offset_hours)
                end_time = rec.end_date + timedelta(hours=offset_hours)
                
                if self.start_date > rec.start_date and self.end_date < rec.end_date and self.room_location == rec.room_location :
                    raise AccessDenied(f"Meeting Room Already Used from {start_time} to {end_time},  in {rec.room_location.name} Please Choose Another Schedule")
                elif self.start_date > rec.start_date and self.start_date < rec.end_date and self.room_location == rec.room_location:
                    raise AccessDenied(f"Meeting Room Already Used from {start_time} to {end_time},in {rec.room_location.name} Please Choose Another Schedule")
                elif self.end_date > rec.start_date and self.end_date < rec.end_date and self.room_location == rec.room_location :
                    raise AccessDenied(f"Meeting Room Already Used from {start_time} to {end_time},in {rec.room_location.name} Please Choose Another Schedule")
                elif self.start_date < rec.start_date and self.end_date > rec.end_date and self.room_location == rec.room_location :
                    raise AccessDenied(f"Meeting Room Already Used from {start_time} to {end_time},in {rec.room_location.name} Please Choose Another Schedule")
                elif self.start_date == rec.start_date and self.end_date > rec.end_date and self.room_location == rec.room_location :
                    raise AccessDenied(f"Meeting Room Already Used from {start_time} to {end_time},in {rec.room_location.name} Please Choose Another Schedule")
                elif self.start_date == rec.start_date and self.end_date == rec.end_date and self.room_location == rec.room_location and self.id != rec.id :
                    raise AccessDenied(f"Meeting Room Already Used from {start_time} to {end_time},in {rec.room_location.name} Please Choose Another Schedule")

    @api.model
    def create(self, vals):
        self._check_readonly_access()

        vals['name'] = vals['subject']
        values = super(MeetingRooms, self).create(vals)
        
        # REVISI PENTING: KODE ACTIVITY SCHEDULE DI SINI SUDAH SAYA HAPUS.
        # SEKARANG CREATE MURNI HANYA MEMBUAT DATA TANPA NOTIFIKASI SPAM.

        if not self.env.context.get('skip_double_booking_check'):
            tz = pytz.timezone(values.room_location.tz or "Asia/Singapore")
            current_offset = datetime.now(pytz.utc).astimezone(tz).utcoffset()
            offset_hours = current_offset.total_seconds() / 3600
            start_time = values.start_date + timedelta(hours=offset_hours)
            end_time = values.end_date + timedelta(hours=offset_hours)
            formatted_start_time = start_time.strftime('%b %d, %Y')
            start_time_hours = start_time.strftime('%H:%M')
            formatted_end_time = end_time.strftime('%b %d, %Y %H:%M')
            end_time_hours = end_time.strftime('%H:%M')
            duration = end_time - start_time
            meeting_hours, remainder = divmod(duration.total_seconds(), 3600)
            meeting_minutes, meeting_seconds = divmod(remainder, 60)
            meeting_hours_str = ""
            if meeting_hours > 0:
                meeting_hours_str = f"{int(meeting_hours)} hours "

            meeting_minutes_str = ""
            if meeting_minutes > 0:
                meeting_minutes_str = f"{int(meeting_minutes)} minutes"

        if values.recurrency :
            if values.rrule_type == "daily" :
                delta = timedelta(days=1)
                start_date = values.start_date
                end_date = values.end_date
                date_count = values.start_date.date()
                while date_count <= values.final_date :
                    start_date += delta
                    end_date += delta
                    date_count += delta
                    value = {
                        'subject' : values.subject,
                        'name' : values.name,
                        'start_date' : start_date,
                        'end_date' : end_date,
                        'description' : values.description,
                        'calendar_alarm' : values.calendar_alarm.id,
                        'attendee' : values.attendee,
                        'room_location' : values.room_location.id
                    }
                    meeting = self.env['meeting.rooms'].sudo().with_context(bypass_security_check=True).create(value)

            elif values.rrule_type == "weekly":
                delta = timedelta(days=7)
                start_date = values.start_date
                end_date = values.end_date
                date_count = values.start_date.date()
                while date_count <= values.final_date:
                    start_date += delta
                    end_date += delta
                    date_count += delta
                    value = {
                        'subject': values.subject,
                        'name': values.name,
                        'start_date': start_date,
                        'end_date': end_date,
                        'description': values.description,
                        'calendar_alarm': values.calendar_alarm.id,
                        'attendee': values.attendee,
                        'room_location': values.room_location.id
                    }
                    meeting = self.env['meeting.rooms'].sudo().with_context(bypass_security_check=True).create(value)
        return values

    def write(self,vals):
        self._check_readonly_access()
        if self.env.context.get('force_sync'):
            return super(MeetingRooms, self).write(vals)

        is_manager = self.env.user.has_group('meeting_rooms.group_meeting_manager')

        if self.create_uid != self.env.user and not is_manager :
            raise AccessDenied(f"Only Initiator ({self.create_uid.name}) Or Meeting Administrator can Edit")
        else :
            return super(MeetingRooms, self).write(vals)

=== FILE: ./models/meeting_event.py ===
# -*- coding: utf-8 -*-
from odoo import models, fields, api, _
from odoo.exceptions import ValidationError, UserError
from datetime import datetime, timedelta
import pytz
import base64
import logging
import requests
from requests.auth import HTTPBasicAuth
import urllib.parse
import json

_logger = logging.getLogger(__name__)

# Helper untuk Timezone
_tzs = [(tz, tz) for tz in sorted(pytz.all_timezones, key=lambda tz: tz if not tz.startswith('Etc/') else '_')]
def _tz_get(self):
    return _tzs

class MeetingEvent(models.Model):
    _name = 'meeting.event'
    _inherit = ['mail.thread', 'mail.activity.mixin']
    _description = 'Meeting Event (Master)'
    _rec_name = 'subject'

    # ==========================================================
    # AUTO-ADD HOST TO ATTENDEE
    # ==========================================================
    @api.model
    def create(self, vals):
        res = super(MeetingEvent, self).create(vals)
        if res.create_uid.id not in res.attendee.ids:
            res.write({
                'attendee': [(4, res.create_uid.id)] 
            })
        return res

    # =========================
    # MAIN FIELDS
    # =========================
    subject = fields.Char("Subject", required=True, tracking=True)
    room_location_ids = fields.Many2many('room.location', string="Locations")
    virtual_room_id = fields.Many2one('virtual.room', string="Virtual Room Provider")

    start_date = fields.Datetime("Start", required=True)
    end_date = fields.Datetime("End", required=True)
    attendee = fields.Many2many("res.users", string="Attendee")
    description = fields.Text("Description")
    calendar_alarm = fields.Many2one("calendar.alarm", string="Reminder")

    # === NEW FIELD: KHUSUS TAMU EKSTERNAL ===
    guest_partner_id = fields.Many2one(
        'res.partner', 
        string="External Guest", 
        help="Data tamu yang booking dari portal"
    )
    # ========================================

    # REVISI: Poin 7 - Jangan copy data Zoom/Summary saat Duplicate (copy=False)
    zoom_id = fields.Char(string="Meeting ID", readonly=True, copy=False) 
    zoom_link = fields.Char(string="Join URL", readonly=True, copy=False)
    zoom_invitation = fields.Text(string="Invitation Text", copy=False)
    zoom_start_url = fields.Char(string='Start URL', readonly=True, copy=False)
    ai_summary = fields.Html(string='AI Summary Result', sanitize=False, copy=False)

    recurrency = fields.Boolean('Recurrent', help="Recurrent Meeting")
    rrule_type = fields.Selection([
        ('daily', 'Daily'),
        ('weekly', 'Weekly')
    ], string='Recurrence', help="Let the event automatically repeat at that interval")
    final_date = fields.Date('Repeat Until')

    version = fields.Integer("Version", default=1)
    calendar_file = fields.Binary(string="Calendar File")

    state = fields.Selection(
        [('draft', 'Draft'), ('confirm', 'Confirm'), ('cancel', 'Cancelled')],
        string='Status', default='draft', tracking=True
    )

    meeting_room_ids = fields.One2many(
        'meeting.rooms', 
        'meeting_event_id', 
        string="Booked Rooms List",
        readonly=True 
    )

    # ==========================================================
    # LOGIC UTAMA: GENERATE ACTIVITY (DIPANGGIL SAAT CONFIRM & EDIT)
    # ==========================================================
    def _regenerate_all_activities(self):
        """ 
        LOGIKA 'WIPE & REGENERATE':
        1. Hapus SEMUA activity lama yang terhubung ke Event ini (Termasuk punya orang yg sudah dihapus).
        2. Buat activity BARU untuk attendee yang sekarang ada.
        """
        self.ensure_one()
        ev = self

        # Jangan buat activity jika sedang dalam proses SYNC data legacy
        if self.env.context.get('mail_activity_automation_skip'):
            return

        # === 1. HAPUS BERSIH (WIPE) ===
        # Cari activity apapun yang nempel di record ini
        old_activities = self.env['mail.activity'].search([
            ('res_id', '=', ev.id),
            ('res_model', '=', 'meeting.event')
        ])
        # Hapus semuanya! Biar Budi yang sudah dikick notifikasinya hilang.
        old_activities.unlink()

        # === 2. SIAPKAN DATA BARU ===
        loc = ev.room_location_ids[0] if ev.room_location_ids else False
        tz_name = loc.tz if loc and loc.tz else "Asia/Singapore"
        loc_name = ", ".join(ev.room_location_ids.mapped('name'))
        
        tz = pytz.timezone(tz_name)
        current_offset = datetime.now(pytz.utc).astimezone(tz).utcoffset()
        offset_hours = current_offset.total_seconds() / 3600

        start_time = ev.start_date + timedelta(hours=offset_hours)
        end_time = ev.end_date + timedelta(hours=offset_hours)

        formatted_start_time = start_time.strftime('%b %d, %Y')
        start_time_hours = start_time.strftime('%H:%M')
        end_time_hours = end_time.strftime('%H:%M')
        
        duration = end_time - start_time
        meeting_hours, remainder = divmod(duration.total_seconds(), 3600)
        meeting_minutes, meeting_seconds = divmod(remainder, 60)
        meeting_hours_str = f"{int(meeting_hours)} hours " if meeting_hours > 0 else ""
        meeting_minutes_str = f"{int(meeting_minutes)} minutes" if meeting_minutes > 0 else ""

        virtual_room_info = ""
        if ev.zoom_link:
                virtual_room_info = f"<br/><br/><b>Online Meeting:</b> <a href='{ev.zoom_link}' target='_blank'>Click to Join</a>"
        elif ev.virtual_room_id:
            virtual_room_info = f"<br/>(Virtual Room: {ev.virtual_room_id.name})"

        # === 3. BUAT BARU (REGENERATE) ===
        # Loop hanya untuk attendee yang SEKARANG ada
        for user in ev.attendee:
            ev.activity_schedule(
                'meeting_rooms.mail_act_meeting_rooms_approval',
                user_id=user.id,
                date_deadline=start_time.date(),
                note=f"""
                    Hi <b>{user.name}</b>,<br/><br/>
                    I hope this message finds you well. <b>{ev.create_uid.name}</b> has invited you to the "{ev.subject}" meeting<br/><br/>
                    <table border="0">
                        <tbody>
                            <tr>
                                <td style="width:80px;">Date</td>
                                <td>: {formatted_start_time}</td>
                            </tr>
                            <tr>
                                <td>Time</td>
                                <td>: {start_time_hours} - {end_time_hours} ({tz_name}'s Time)</td>
                            </tr>
                            <tr>
                                <td>Duration</td>
                                <td>: {meeting_hours_str}{meeting_minutes_str}</td>
                            </tr>
                            <tr>
                                <td>Location</td>
                                <td>: {loc_name} {virtual_room_info}</td>
                            </tr>
                        </tbody>
                    </table>
                    <br/>
                """
            )

    # ==========================
    # WRITE / EDIT LOGIC (PERBAIKAN DISINI)
    # ==========================
    def write(self, vals):
        # 1. Cek apakah jadwal atau virtual room berubah?
        # REVISI: Poin 6 - Otomatis Regenerate jika jadwal berubah
        reschedule_fields = ['start_date', 'end_date', 'virtual_room_id']
        is_rescheduling = any(f in vals for f in reschedule_fields)

        # Jika sedang reschedule dan sudah ada Zoom Link sebelumnya, kita harus "Reset" linknya
        # karena link lama mungkin sudah tidak valid jamnya.
        if is_rescheduling:
            vals['zoom_id'] = False
            vals['zoom_link'] = False
            vals['zoom_start_url'] = False
            vals['zoom_invitation'] = False
            vals['ai_summary'] = False # Summary lama tidak relevan lagi

        # Field lain yang memicu update activity
        trigger_fields = ['room_location_ids', 'subject', 'attendee', 'zoom_link']
        is_update_needed = is_rescheduling or any(f in vals for f in trigger_fields)
        
        # 2. Simpan dulu perubahan datanya ke database
        res = super(MeetingEvent, self).write(vals)

        # 3. Jalankan Logika Sync & Activity SETELAH data tersimpan
        for ev in self:
            # Sync Booking Ruangan (Meeting Rooms) jika bukan dari context skip
            if not self.env.context.get('skip_rooms_sync'):
                ev._sync_rooms_from_event()

            # Update Activity Peserta (Hanya kalau status Confirm)
            if ev.state == 'confirm' and is_update_needed:
                ev._regenerate_all_activities()

            # REVISI: Jika tadi di-reset karena reschedule, beri notifikasi di chatter
            if is_rescheduling and ev.state == 'confirm':
                ev.message_post(body="<b>Jadwal/Ruangan Berubah.</b> Link Meeting lama telah dihapus. Silakan klik tombol 'Generate Meeting Link' lagi.")
                        
        return res

    # ==========================
    # ACTION CONFIRM
    # ==========================
    def action_confirm(self):
        for ev in self:
            # Sama, pakai fungsi Wipe & Regenerate biar konsisten
            ev._regenerate_all_activities()
            
            ev.write({'state': 'confirm'})
            ev.with_context(skip_booking_check=True)._sync_rooms_from_event()
        return True

    # ==========================================================
    # VIRTUAL ROOM ACTIONS & HELPERS
    # ==========================================================
    def action_generate_virtual_link(self):
        self.ensure_one()
        if not self.virtual_room_id:
            raise UserError(_("Please select a Virtual Room first."))
        
        provider = getattr(self.virtual_room_id, 'provider', 'zoom')
        
        if provider == 'zoom':
            self._logic_generate_zoom()
        elif provider == 'google_meet':
            self._logic_generate_google_meet()
        elif provider == 'teams':
            self._logic_generate_teams()
        else:
            self._logic_generate_manual_link()

    def _get_zoom_credentials(self):
        self.ensure_one()
        account_id = self.virtual_room_id.zoom_account_id
        client_id = self.virtual_room_id.zoom_client_id
        client_secret = self.virtual_room_id.zoom_client_secret

        if not account_id or not client_id or not client_secret:
            raise UserError(_("Zoom Credentials (Account/Client/Secret) missing."))    
        return account_id, client_id, client_secret

    def _get_zoom_access_token(self):
        account_id, client_id, client_secret = self._get_zoom_credentials()
        url = f"https://zoom.us/oauth/token?grant_type=account_credentials&account_id={account_id}"
        try:
            response = requests.post(url, auth=HTTPBasicAuth(client_id, client_secret), timeout=30)
            response.raise_for_status()
            return response.json()['access_token']
        except Exception as e:
            _logger.error("Zoom Auth Error: %s", e)
            raise UserError(_("Zoom connection failed: %s") % e)

    def _get_zoom_headers(self):
        token = self._get_zoom_access_token()
        return {'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json'}

    def _logic_generate_zoom(self):
        if self.zoom_id:
            raise UserError(_("Meeting Link already exists!"))

        duration_seconds = (self.end_date - self.start_date).total_seconds()
        duration_minutes = int(duration_seconds / 60)

        loc = self.room_location_ids[0] if self.room_location_ids else False
        host_tz = loc.tz if loc and loc.tz else 'Asia/Singapore'

        url = "https://api.zoom.us/v2/users/me/meetings"
        headers = self._get_zoom_headers() 
        
        payload = {
            "topic": self.subject,
            "type": 2, 
            "start_time": self.start_date.isoformat(),
            "duration": duration_minutes,
            "timezone": host_tz,
            "settings": {
                "host_video": True,
                "participant_video": True,
                "auto_recording": "cloud"
            }
        }
        
        try:
            res = requests.post(url, headers=headers, json=payload, timeout=30)
            res.raise_for_status()
            zoom_response = res.json()
        except Exception as e:
            raise UserError(_("Failed to create Zoom meeting: %s") % e)

        join_url = zoom_response.get('join_url', '')
        meeting_id = str(zoom_response.get('id', ''))
        password = zoom_response.get('password', '')

        self.write({
            'zoom_id': meeting_id,
            'zoom_link': join_url,
            'zoom_start_url': zoom_response.get('start_url', ''),
        })

        self._generate_invitation_text("Zoom Meeting", join_url, meeting_id, password)
        
        # REVISI: Poin 5 - Link open in new tab (target="_blank")
        self.message_post(body=f"Zoom Meeting Created: <a href='{join_url}' target='_blank'>{join_url}</a>")

    def _logic_generate_google_meet(self):
        static_link = getattr(self.virtual_room_id, 'static_link', False) 
        if not static_link:
            raise UserError(_("No static Google Meet link defined in Virtual Room master."))

        self.write({
            'zoom_id': 'Google Meet', 
            'zoom_link': static_link,
            'zoom_start_url': static_link,
        })
        
        self._generate_invitation_text("Google Meet", static_link)
        
        # REVISI: Poin 5 - Link open in new tab (target="_blank")
        self.message_post(body=f"Google Meet Link Attached: <a href='{static_link}' target='_blank'>{static_link}</a>")

    def _get_teams_token(self):
        tenant_id = self.virtual_room_id.zoom_account_id
        client_id = self.virtual_room_id.zoom_client_id
        client_secret = self.virtual_room_id.zoom_client_secret

        if not tenant_id or not client_id or not client_secret:
            raise UserError(_("Untuk Teams, mohon isi: Account ID (Tenant), Client ID, dan Secret."))

        url = f"https://login.microsoftonline.com/{tenant_id}/oauth2/v2.0/token"
        payload = {
            'grant_type': 'client_credentials',
            'client_id': client_id,
            'client_secret': client_secret,
            'scope': 'https://graph.microsoft.com/.default'
        }
        
        try:
            res = requests.post(url, data=payload, timeout=30)
            res.raise_for_status()
            return res.json().get('access_token')
        except Exception as e:
             raise UserError(_("Gagal login ke Microsoft Azure: %s") % e)

    def _logic_generate_teams(self):
        if self.zoom_id:
            raise UserError(_("Link sudah ada!"))

        token = self._get_teams_token()
        host_email = self.virtual_room_id.email or self.env.user.email
        if not host_email:
             raise UserError(_("Butuh Email Host untuk membuat Teams Meeting."))

        try:
            user_url = f"https://graph.microsoft.com/v1.0/users/{host_email}"
            user_res = requests.get(user_url, headers={'Authorization': 'Bearer ' + token}, timeout=30)
            if user_res.status_code != 200:
                 raise UserError(_("User dengan email %s tidak ditemukan di Azure AD.") % host_email)
            azure_user_id = user_res.json().get('id')
        except Exception as e:
            raise UserError(_("Gagal mencari user Azure: %s") % e)

        create_url = f"https://graph.microsoft.com/v1.0/users/{azure_user_id}/onlineMeetings"
        
        start_dt = self.start_date.isoformat() + "Z" 
        end_dt = self.end_date.isoformat() + "Z"   
        
        payload = {
            "startDateTime": start_dt,
            "endDateTime": end_dt,
            "subject": self.subject,
        }

        try:
            res = requests.post(create_url, headers={'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json'}, json=payload, timeout=30)
            res.raise_for_status()
            data = res.json()
            join_url = data.get('joinWebUrl')
            
            self.write({
                'zoom_id': 'Microsoft Teams', 
                'zoom_link': join_url,
                'zoom_start_url': join_url,
            })
            
            self._generate_invitation_text("Microsoft Teams", join_url)
            
            # REVISI: Poin 5 - Link open in new tab (target="_blank")
            self.message_post(body=f"Teams Meeting Created: <a href='{join_url}' target='_blank'>Join Teams</a>")

        except Exception as e:
            raise UserError(_("Gagal membuat meeting Teams: %s") % e)

    def _logic_generate_manual_link(self):
        raise UserError(_("Logic provider ini belum diimplementasikan."))

    def _generate_invitation_text(self, provider_name, url, mid=False, pwd=False):
        text = (
            f"Topic: {self.subject}\n"
            f"Time: {self.start_date}\n\n"
            f"Join {provider_name}\n{url}\n\n"
        )
        if mid and mid != 'Google Meet' and mid != 'Microsoft Teams':
            text += f"Meeting ID: {mid}\n"
        if pwd:
            text += f"Passcode: {pwd}"
        self.write({'zoom_invitation': text})

    def action_get_ai_summary(self):
        self.ensure_one()
        provider = getattr(self.virtual_room_id, 'provider', 'zoom')
        if provider != 'zoom':
            raise UserError(_("AI Summary saat ini hanya tersedia untuk Zoom."))

        if not self.zoom_id:
            raise UserError(_("No Meeting ID found."))
        
        new_summary = self._logic_fetch_formatted_summary(self.zoom_id)
        if not new_summary:
            raise UserError(_("Failed to fetch summary. Meeting might not have AI Summary enabled or is not finished yet."))

        header_style = "border-top: 2px solid #00A09D; margin-top: 20px; padding-top: 10px; color: #00A09D;"
        divider = f"<div style='{header_style}'><h3> Meeting AI Summary Result</h3></div>"
        self.write({'ai_summary': divider + new_summary})

    def _logic_fetch_formatted_summary(self, mid):
        content = self._try_fetch_summary(mid)
        if not content:
            uuid = self._find_past_meeting_uuid(mid)
            if uuid:
                encoded_uuid = urllib.parse.quote(urllib.parse.quote(uuid, safe=''), safe='')
                content = self._try_fetch_summary(encoded_uuid)
        return content

    def _try_fetch_summary(self, mid):
        url = f"https://api.zoom.us/v2/meetings/{mid}/meeting_summary"
        try:
            res = requests.get(url, headers=self._get_zoom_headers(), timeout=30)
            if res.status_code != 200:
                _logger.error("Zoom API Error: Status %s - Body: %s", res.status_code, res.text)
                return False

            data = res.json()
            html_content = ""
            title = data.get('summary_title')
            if title: html_content += f"<h2>{title}</h2>"
            overview = data.get('summary_overview')
            if overview:
                html_content += (f"<div style='background-color:#f8f9fa; padding:15px; margin-bottom: 20px;'>"
                                 f"<strong style='color:#00A09D;'>Quick Recap:</strong><br/>{overview}</div>")
            
            details = data.get('summary_details', [])
            if details:
                html_content += "<hr/><h4> Detailed Summary:</h4>"
                for item in details:
                    label = item.get('label') or 'Topic'
                    summary_text = item.get('summary', '')
                    if isinstance(summary_text, list): summary_text = " ".join(summary_text)
                    html_content += (f"<div style='margin-bottom: 15px;'><strong style='font-size: 1.1em; color: #2C3E50;'>{label}</strong>"
                                     f"<p>{summary_text}</p></div>")
            return html_content
        except Exception as e:
            _logger.error("Zoom Summary Exception: %s", e)
            return False

    def _find_past_meeting_uuid(self, mid):
        url = f"https://api.zoom.us/v2/past_meetings/{mid}/instances"
        try:
            res = requests.get(url, headers=self._get_zoom_headers(), timeout=30)
            if res.status_code == 200 and res.json().get('meetings'):
                return res.json()['meetings'][-1].get('uuid')
        except Exception:
            return False
        return False

    def _get_alarm_id(self):
        self.ensure_one()
        if self.calendar_alarm:
            return self.calendar_alarm.id
        alarm = self.env['calendar.alarm'].search([], limit=1)
        return alarm.id if alarm else False

    def _sync_rooms_from_event(self):
        MeetingRooms = self.env['meeting.rooms']
        for ev in self:
            if ev.state != 'confirm':
                continue
            
            existing = MeetingRooms.search([('meeting_event_id', '=', ev.id)])
            by_loc = {r.room_location.id: r for r in existing if r.room_location}
            alarm_id = ev._get_alarm_id()
            keep_ids = []

            for loc in ev.room_location_ids:
                vals = {
                    'meeting_event_id': ev.id,
                    'subject': ev.subject,
                    'name': ev.subject,
                    'room_location': loc.id,
                    'virtual_room_id': ev.virtual_room_id.id, 
                    'start_date': ev.start_date,
                    'end_date': ev.end_date,
                    'description': ev.description,
                    'attendee': [(6, 0, ev.attendee.ids)],
                    'recurrency': ev.recurrency,
                    'rrule_type': ev.rrule_type,
                    'final_date': ev.final_date,
                    'state': 'confirm',
                }

                if alarm_id:
                    vals['calendar_alarm'] = alarm_id

                # TAMBAHKAN CONTEXT bypass_security_check=True agar lolos gembok
                if loc.id in by_loc:
                    by_loc[loc.id].with_context(skip_event_sync=True, skip_booking_check=True, bypass_security_check=True).write(vals)
                    keep_ids.append(by_loc[loc.id].id)
                else:
                    new_b = MeetingRooms.with_context(skip_event_sync=True, skip_booking_check=True, bypass_security_check=True).create(vals)
                    keep_ids.append(new_b.id)

            leftovers = existing.filtered(lambda r: r.id not in keep_ids)
            if leftovers:
                leftovers.with_context(skip_event_sync=True, skip_booking_check=True, bypass_security_check=True).write({'state': 'cancel'})

    # =========================================================
    # SATPAM (CONSTRAINTS) - [REVISI: HANYA CONFIRM YG DICEK]
    # =========================================================
    @api.constrains('start_date', 'end_date', 'room_location_ids', 'virtual_room_id', 'attendee', 'state')
    def _check_double_booking(self):
        if self.env.context.get('skip_double_booking_check'):
            return

        for ev in self:
            if ev.state != 'confirm':
                continue

            base_domain = [
                ('id', '!=', ev.id),                
                ('state', '=', 'confirm'), 
                ('start_date', '<', ev.end_date),   
                ('end_date', '>', ev.start_date),   
            ]

            if ev.room_location_ids:
                domain_loc = base_domain + [('room_location_ids', 'in', ev.room_location_ids.ids)]
                conflict_loc = self.search(domain_loc, limit=1)
                if conflict_loc:
                    clashed_rooms = set(ev.room_location_ids.mapped('name')) & set(conflict_loc.room_location_ids.mapped('name'))
                    raise ValidationError(
                        f"TABRAKAN LOKASI!\n"
                        f"Ruangan {', '.join(clashed_rooms)} sudah dipesan untuk meeting '{conflict_loc.subject}'."
                    )

            if ev.virtual_room_id:
                domain_virtual = base_domain + [('virtual_room_id', '=', ev.virtual_room_id.id)]
                conflict_virtual = self.search(domain_virtual, limit=1)
                if conflict_virtual:
                    raise ValidationError(
                        f"TABRAKAN VIRTUAL ROOM!\n"
                        f"Akun Virtual '{ev.virtual_room_id.name}' sedang dipakai untuk meeting '{conflict_virtual.subject}'."
                    )

            if ev.attendee:
                domain_user = base_domain + [('attendee', 'in', ev.attendee.ids)]
                conflict_user = self.search(domain_user, limit=1)
                if conflict_user:
                    busy_people = set(ev.attendee.mapped('name')) & set(conflict_user.attendee.mapped('name'))
                    if busy_people:
                        raise ValidationError(
                            f"TABRAKAN PESERTA!\n"
                            f"Peserta berikut: {', '.join(busy_people)} "
                            f"sudah memiliki jadwal meeting lain ('{conflict_user.subject}')."
                        )

    def create_calendar_web(self):
        self.ensure_one()
        rec = self
        
        # 1. Setup Data Waktu & Tempat
        loc = rec.room_location_ids[0] if rec.room_location_ids else False
        tz_name = loc.tz if loc and loc.tz else "Asia/Singapore"
        loc_name = ", ".join(rec.room_location_ids.mapped('name'))
        
        tz = pytz.timezone(tz_name)
        current_offset = datetime.now(pytz.utc).astimezone(tz).utcoffset()
        offset_hours = current_offset.total_seconds() / 3600

        start_time = rec.start_date + timedelta(hours=offset_hours)
        end_time = rec.end_date + timedelta(hours=offset_hours)
        create_time = rec.create_date + timedelta(hours=offset_hours)
        
        formatted_start_time = start_time.strftime('%b %d, %Y')
        start_time_hours = start_time.strftime('%H:%M')
        end_time_hours = end_time.strftime('%H:%M')
        
        duration = end_time - start_time
        meeting_hours, remainder = divmod(duration.total_seconds(), 3600)
        meeting_minutes, meeting_seconds = divmod(remainder, 60)
        meeting_hours_str = f"{int(meeting_hours)} hours " if meeting_hours > 0 else ""
        meeting_minutes_str = f"{int(meeting_minutes)} minutes" if meeting_minutes > 0 else ""

        reminder = int(rec.calendar_alarm.duration) if rec.calendar_alarm and rec.calendar_alarm.duration else 15
        
        # 2. Build Attendee String untuk ICS
        attendee_str = ''
        for user in rec.attendee:
            if user.email:
                attendee_str += f'ATTENDEE;ROLE=REQ-PARTICIPANT;RSVP=TRUE;CN="{user.display_name}":mailto:{user.email}\n'
        
        # Tambahkan Guest ke ICS juga (opsional, biar rapi)
        if rec.guest_partner_id and rec.guest_partner_id.email:
             attendee_str += f'ATTENDEE;ROLE=REQ-PARTICIPANT;RSVP=TRUE;CN="{rec.guest_partner_id.name}":mailto:{rec.guest_partner_id.email}\n'

        timezone_offset = datetime.now(pytz.utc).astimezone(tz).utcoffset().total_seconds() / 60
        off_h = int(timezone_offset // 60)
        off_m = int(abs(timezone_offset) % 60)
        tz_offset_str = f"{'+' if off_h >= 0 else '-'}{abs(off_h):02d}{abs(off_m):02d}"

        display_location = loc_name
        description_text = rec.description or ''
        
        if rec.zoom_link:
            display_location += " (Online Meeting Available)"
            description_text += f"\n\nJoin Link: {rec.zoom_link}"
            if rec.zoom_id and rec.zoom_id != 'Google Meet' and rec.zoom_id != 'Microsoft Teams':
                description_text += f"\nMeeting ID: {rec.zoom_id}"
        elif rec.virtual_room_id:
            display_location += f" (Virtual: {rec.virtual_room_id.name})"

        # 3. Generate ICS Content
        icsContent = f"""BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Odoo Meeting Rooms//EN
CALSCALE:GREGORIAN
METHOD:REQUEST
BEGIN:VTIMEZONE
TZID:{tz_name}
X-LIC-LOCATION:{tz_name}
BEGIN:STANDARD
DTSTART:19700101T000000
TZOFFSETFROM:{tz_offset_str}
TZOFFSETTO:{tz_offset_str}
TZNAME:{tz_name}
END:STANDARD
END:VTIMEZONE
BEGIN:VEVENT
UID:meeting_event_{rec.id}
SEQUENCE:{rec.version}
SUMMARY:{rec.subject}
DTSTAMP:{create_time.strftime('%Y%m%dT%H%M%S')}
DTSTART;TZID={tz_name}:{start_time.strftime('%Y%m%dT%H%M%S')}
DTEND;TZID={tz_name}:{end_time.strftime('%Y%m%dT%H%M%S')}
LOCATION:{display_location}
DESCRIPTION:{description_text}
ORGANIZER;PARTSTAT=ACCEPTED;CN="{rec.create_uid.display_name}":mailto:{rec.create_uid.email}
{attendee_str}BEGIN:VALARM
TRIGGER:-PT{reminder}M
ACTION:DISPLAY
DESCRIPTION:Reminder
END:VALARM
END:VEVENT
END:VCALENDAR"""

        filename = f"{rec.subject}.ics"
        encoded_ics = base64.b64encode(icsContent.encode('utf-8'))
        
        # Buat/Update Attachment
        Attachment = self.env['ir.attachment'].sudo()
        existing_att = Attachment.search([
            ('res_model', '=', 'meeting.event'),
            ('res_field', '=', 'calendar_file'),
            ('res_id', '=', rec.id)
        ])
        if existing_att:
            existing_att.unlink()
            
        attachment = Attachment.create({
            'name': filename,
            'type': 'binary',
            'res_model': 'meeting.event',
            'res_field': 'calendar_file',
            'res_id': rec.id,
            'datas': encoded_ics,
            'public': True
        })

        # ========================================================
        # [NEW LOGIC] MENGUMPULKAN PENERIMA EMAIL (DISINI POSISINYA)
        # ========================================================
        recipients = [rec.create_uid.email] # 1. Host (Pasti dapat)
        
        # 2. Dari Attendee (Internal User / Karyawan)
        for user in rec.attendee:
            if user.email:
                recipients.append(user.email)
        
        # 3. Dari Field Guest (Tamu Eksternal) --> INI BAGIAN BARUNYA
        if rec.guest_partner_id and rec.guest_partner_id.email:
            recipients.append(rec.guest_partner_id.email)

        # Bersihkan duplikat & email kosong
        recipients_email = ",".join(filter(None, list(set(recipients))))

        # 4. Kirim Email (Hanya jika ada penerima)
        virtual_room_info = ""
        if rec.zoom_link:
             virtual_room_info = f"<br/><br/><b>Online Meeting:</b> <a href='{rec.zoom_link}' target='_blank'>Click to Join</a>"
        elif rec.virtual_room_id:
            virtual_room_info = f"<br/>(Virtual Room: {rec.virtual_room_id.name})"

        if recipients_email:
            email_body = f"""
            <div style="font-family: sans-serif;">
                Hi Team & Guest,<br/><br/>
                <b>{rec.create_uid.name}</b> has invited you to the "{rec.subject}" meeting<br/><br/>
                <table border="0" style="background-color: #f9f9f9; padding: 10px; border-radius: 5px;">
                    <tbody>
                        <tr><td style="width:80px;"><b>Date</b></td><td>: {formatted_start_time}</td></tr>
                        <tr><td><b>Time</b></td><td>: {start_time_hours} - {end_time_hours} ({tz_name})</td></tr>
                        <tr><td><b>Location</b></td><td>: {loc_name} {virtual_room_info}</td></tr>
                    </tbody>
                </table>
                <br/>
                Please <b>download the attachment</b> to save this to your calendar.<br/><br/>
            </div>
            """
            
            mail_values = {
                'subject': f"Invitation: {rec.subject}",
                'email_from': rec.create_uid.email_formatted,
                'email_to': recipients_email,
                'body_html': email_body,
                'attachment_ids': [(4, attachment.id)]
            }
            mail = self.env['mail.mail'].sudo().create(mail_values)
            mail.send()
            
            # Catat log
            rec.message_post(body=f"Email Invitation sent to: {recipients_email}")

        return {
            'type': 'ir.actions.act_url',
            'url': f'/web/content/{attachment.id}?download=true',
            'target': 'self',
        }

    def action_cancel(self):
        MeetingRooms = self.env['meeting.rooms']
        for ev in self:
            # 1. Custom Log Message
            loc_name = ", ".join(ev.room_location_ids.mapped('name'))
            msg_body = f"Meeting <b>{ev.subject}</b> from {ev.start_date} to {ev.end_date} in <b>{loc_name}</b> Is Cancelled"
            ev.message_post(body=msg_body)

            # 2. Hapus Activity Peserta agar tidak ada hutang task (Wipe)
            existing_activities = self.env['mail.activity'].search([
                ('res_id', '=', ev.id),
                ('res_model', '=', 'meeting.event')
            ])
            existing_activities.unlink()

            # 3. Logika Cancel Anak-anaknya
            rooms = MeetingRooms.search([('meeting_event_id', '=', ev.id)])
            if rooms:
                # TAMBAHKAN bypass_security_check=True
                rooms.with_context(skip_event_sync=True, skip_booking_check=True, bypass_security_check=True).write({'state': 'cancel'})
            
            # 4. Cancel Diri Sendiri
            ev.write({'state': 'cancel'})
        return True

    def action_draft(self):
        MeetingRooms = self.env['meeting.rooms']
        for ev in self:
            rooms = MeetingRooms.search([('meeting_event_id', '=', ev.id)])
            if rooms:
                # TAMBAHKAN bypass_security_check=True
                rooms.with_context(skip_event_sync=True, skip_booking_check=True, bypass_security_check=True).write({'state': 'draft'})
            ev.write({'state': 'draft'})
        return True

    # ==========================
    # CRON JOB HANDLER
    # ==========================
    @api.model
    def _cron_auto_delete_activities(self):
        # Hapus activity basi milik Meeting EVENT (Bapaknya)
        activities_event = self.env['mail.activity'].search([
            ('res_model', '=', 'meeting.event'),
            ('date_deadline', '<', fields.Date.today())
        ])

        # Hapus activity basi milik Meeting ROOMS (Anaknya)
        activities_rooms = self.env['mail.activity'].search([
            ('res_model', '=', 'meeting.rooms'),
            ('date_deadline', '<', fields.Date.today())
        ])

        # Gabungkan hasil tangkapan
        all_activities = activities_event + activities_rooms
        count = len(all_activities)

        if count > 0:
            all_activities.unlink()
            _logger.info(f"CRON JOB: SUKSES MENGHAPUS {count} Schedule Activity Basi (Gabungan Event & Rooms).")
        else:
            _logger.info("CRON JOB: Tidak ditemukan activity basi (kurang dari hari ini).")

=== FILE: ./models/meeting_rooms_ext.py ===
# -*- coding: utf-8 -*-
from odoo import models, fields, api, _
from odoo.exceptions import ValidationError

class MeetingRoomsExt(models.Model):
    _inherit = 'meeting.rooms'

    # ---------------------------------------------------------------------
    # LINK FIELD
    # ---------------------------------------------------------------------
    # REVISI: Ganti 'set null' jadi 'cascade' agar anak ikut terhapus
    meeting_event_id = fields.Many2one(
        'meeting.event',
        string="Meeting Event Ref",
        index=True,
        ondelete='cascade' 
    )

    # =========================================================
    # Helpers
    # =========================================================
    def _has_event_model(self):
        """Safety: jangan KeyError kalau meeting.event belum ter-load."""
        return 'meeting.event' in self.env.registry.models

    def _linked_event(self):
        self.ensure_one()
        if not self._has_event_model():
            return False
        return self.meeting_event_id if self.meeting_event_id else False

    def _push_rooms_to_event(self, ev):
        """
        Push DATA PENTING (Subject, Tanggal, dll) dari meeting.rooms -> meeting.event
        TAPI TIDAK PUSH STATUS.
        """
        self.ensure_one()
        if not ev:
            return

        vals = {
            'subject': self.subject,
            'start_date': self.start_date,
            'end_date': self.end_date,
            'description': self.description,
            'attendee': [(6, 0, self.attendee.ids)],
        }

        if getattr(self, 'calendar_alarm', False) and self.calendar_alarm:
            vals['calendar_alarm'] = self.calendar_alarm.id

        if getattr(self, 'room_location', False) and self.room_location:
            vals['room_location_ids'] = [(6, 0, [self.room_location.id])]

        # Update data ke Event, tapi pakai context skip_rooms_sync agar tidak looping
        ev.with_context(
            skip_rooms_sync=True,
            skip_event_sync=True,
            skip_booking_check=True,
            skip_availability_check=True,
        ).write(vals)

    def _super_call_or_fallback_state(self, rec, state):
        """
        Safety wrapper untuk memanggil fungsi asli tombol.
        """
        self.ensure_one()
        try:
            if state == 'confirm':
                return super(MeetingRoomsExt, rec).action_confirm()
            if state == 'cancel':
                return super(MeetingRoomsExt, rec).action_cancel()
            if state == 'draft':
                return super(MeetingRoomsExt, rec).action_draft()
        except Exception:
            # Fallback jika fungsi asli tidak ada/error
            # PENTING: Tambahkan bypass_security_check disini juga untuk jaga-jaga
            rec.with_context(skip_booking_check=True, bypass_security_check=True).write({'state': state})
            return True

    # =========================================================
    # BUTTON OVERRIDES (ISOLATED LOGIC)
    # =========================================================
    
    def action_confirm(self):
        for rec in self:
            rec._super_call_or_fallback_state(rec, 'confirm')
            if not rec.env.context.get('skip_event_sync'):
                ev = rec._linked_event()
                if ev:
                    rec._push_rooms_to_event(ev)
        return True

    def action_cancel(self):
        for rec in self:
            rec._super_call_or_fallback_state(rec, 'cancel')
        return True

    def action_draft(self):
        for rec in self:
            rec._super_call_or_fallback_state(rec, 'draft')
        return True

    # =========================================================
    # WRITE OVERRIDE
    # =========================================================
    def write(self, vals):
        # NOTE: Kita tidak perlu bypass security check disini secara eksplisit
        # karena write ini dipanggil oleh user atau event.
        # Jika dipanggil event, event sudah bawa context.
        # Jika user, maka kena blokir (sesuai keinginan).
        
        res = super(MeetingRoomsExt, self).write(vals)

        if self.env.context.get('skip_event_sync'):
            return res
        if not self._has_event_model():
            return res

        important = {'subject', 'start_date', 'end_date', 'attendee', 'description', 'calendar_alarm', 'room_location'}
        need_push = bool(important.intersection(vals.keys()))
        
        for rec in self:
            ev = rec._linked_event()
            if not ev:
                continue

            if need_push:
                rec._push_rooms_to_event(ev)

        return res

    # =========================================================
    # LEGACY SYNC (DATA LAMA)
    # =========================================================
    @api.model
    def action_sync_legacy_data(self):
        """
        Dijalankan otomatis saat Upgrade Module via XML.
        Menangani overlap data lama agar tidak error saat install.
        """
        # Cari room yang belum punya bapak (Event)
        orphaned_rooms = self.search([('meeting_event_id', '=', False)])
        
        MeetingEvent = self.env['meeting.event']
        linked_count = 0
        created_count = 0
        skipped_count = 0

        for room in orphaned_rooms:
            # 1. Cek apakah Event sudah ada?
            parent_event = MeetingEvent.search([
                ('subject', '=', room.subject),
                ('start_date', '=', room.start_date),
                ('end_date', '=', room.end_date)
            ], limit=1)

            # Context SAKTI: 
            # - mail_activity_automation_skip: Matikan otomatis activity Odoo standar
            # - skip_double_booking_check: Custom context untuk bypass constrain overlap kita
            ctx_sync = {
                'force_sync': True, 
                'bypass_security_check': True,
                'mail_activity_automation_skip': True, 
                'mail_create_nosubscribe': True,
                'skip_double_booking_check': True # Bypass constrain
            }

            if parent_event:
                # KASUS A: Link ke Event existing
                room.with_context(ctx_sync).write({'meeting_event_id': parent_event.id})
                linked_count += 1
            else:
                # KASUS B: Buatkan Event baru
                # REVISI: Cek manual apakah ada event lain yang overlap?
                # Jika overlap parah, kita buat eventnya dalam status DRAFT saja agar aman.
                
                # Logic sederhana deteksi overlap di Event lain
                overlap = MeetingEvent.search_count([
                    ('start_date', '<', room.end_date),
                    ('end_date', '>', room.start_date),
                    ('state', '=', 'confirm') # Asumsi yang confirm yang valid
                ])
                
                state_to_set = 'confirm'
                if overlap > 0:
                    state_to_set = 'draft' # Turunkan jadi draft jika bentrok
                
                vals = {
                    'subject': room.subject,
                    'start_date': room.start_date,
                    'end_date': room.end_date,
                    'description': room.description,
                    'attendee': [(6, 0, room.attendee.ids)],
                    'state': state_to_set, 
                }
                
                if room.room_location:
                    vals['room_location_ids'] = [(4, room.room_location.id)]
                
                if getattr(room, 'calendar_alarm', False):
                    vals['calendar_alarm'] = room.calendar_alarm.id

                # Create Event Baru dengan Context Aman
                new_event = MeetingEvent.with_context(ctx_sync).create(vals)
                
                # Update Room dengan referensi baru
                room.with_context(ctx_sync).write({'meeting_event_id': new_event.id})
                
                if state_to_set == 'draft':
                    skipped_count += 1
                else:
                    created_count += 1

        if linked_count or created_count or skipped_count:
            print(f"=== [SYNC LEGACY] Linked: {linked_count}, Created: {created_count}, Overlap(Draft): {skipped_count} ===")

=== FILE: ./models/virtual_room.py ===
# -*- coding: utf-8 -*-
from odoo import models, fields, api, _
from odoo.exceptions import UserError
import requests
from requests.auth import HTTPBasicAuth

class VirtualRoom(models.Model):
    _name = 'virtual.room'
    _description = 'Virtual Room Configuration'

    name = fields.Char(string="Name", required=True, help="e.g. Corporate Zoom / Teams IT / Google Meet Link")
    active = fields.Boolean(default=True)
    email = fields.Char(string="Host Email", help="Email host meeting (penting untuk Teams)")

    # === NEW: PROVIDER SELECTION ===
    provider = fields.Selection([
        ('zoom', 'Zoom (API)'),
        ('teams', 'Microsoft Teams (API)'),
        ('google_meet', 'Google Meet (Static Link)'),
    ], string="Provider", default='zoom', required=True)

    # === FIELD KHUSUS GOOGLE MEET / STATIC ===
    static_link = fields.Char(string="Static Link", help="Paste link Google Meet atau link permanen disini")

    # === CREDENTIALS (ZOOM & TEAMS) ===
    # Kita pakai field lama 'zoom_...' untuk menyimpan credential Teams juga (Field Mapping)
    zoom_account_id = fields.Char(string="Account / Tenant ID")
    zoom_client_id = fields.Char(string="Client ID")
    zoom_client_secret = fields.Char(string="Client Secret")

    # REVISI: Tombol Test API
    def action_test_connection(self):
        self.ensure_one()
        if self.provider == 'zoom':
            # Coba ambil Access Token Zoom sebagai tes
            if not self.zoom_account_id or not self.zoom_client_id:
                raise UserError("Credential belum lengkap.")
                
            url = f"https://zoom.us/oauth/token?grant_type=account_credentials&account_id={self.zoom_account_id}"
            try:
                res = requests.post(url, auth=HTTPBasicAuth(self.zoom_client_id, self.zoom_client_secret), timeout=10)
                if res.status_code == 200:
                    token = res.json().get('access_token')
                    return {
                        'type': 'ir.actions.client',
                        'tag': 'display_notification',
                        'params': {
                            'title': 'Connection Successful',
                            'message': 'Zoom API Connected! Token retrieved.',
                            'sticky': False,
                            'type': 'success',
                        }
                    }
                else:
                    raise UserError(f"Zoom Error: {res.text}")
            except Exception as e:
                raise UserError(f"Connection Failed: {str(e)}")
        
        elif self.provider == 'teams':
             # Logic tes teams belum diimplementasi detail, kita kasih warning saja
             raise UserError("Test Connection for Teams belum diimplementasi sepenuhnya.")
        
        elif self.provider == 'google_meet':
             # Google Meet statis tidak butuh tes API
             return {
                'type': 'ir.actions.client',
                'tag': 'display_notification',
                'params': {
                    'title': 'Info',
                    'message': 'Google Meet menggunakan Static Link. Tidak ada API untuk dites.',
                    'type': 'info',
                }
            }

=== FILE: ./models/booking_link.py ===
# -*- coding: utf-8 -*-
from odoo import models, fields, api, _
from odoo.exceptions import UserError
import uuid
from werkzeug.urls import url_join

class ResUsers(models.Model):
    _inherit = 'res.users'

    # Relasi balik ke booking link
    booking_link_ids = fields.One2many('meeting.booking.link', 'user_id', string="Booking Links")
    
    # Field penanda apakah user ini sudah punya link atau belum
    has_booking_link = fields.Boolean(compute='_compute_has_booking_link', store=True)

    @api.depends('booking_link_ids')
    def _compute_has_booking_link(self):
        for user in self:
            # Hitung apakah ada link yang user_id nya adalah user ini
            count = self.env['meeting.booking.link'].search_count([('user_id', '=', user.id)])
            user.has_booking_link = count > 0

class MeetingBookingLink(models.Model):
    _name = 'meeting.booking.link'
    _description = 'Booking Link Configuration'
    _rec_name = 'name'

    _sql_constraints = [
        ('user_id_uniq', 'unique(user_id)', 'User ini sudah memiliki Booking Link! Tidak bisa buat double.')
    ]

    name = fields.Char(string="Link Title", required=True, default="My Booking Link")
    
    user_id = fields.Many2one(
        'res.users', 
        string="Host User", 
        required=True, 
        # default=lambda self: self.env.user,
    )
    
    token = fields.Char("Token", required=True, copy=False, readonly=True, index=True, default=lambda self: self._generate_token())
    active = fields.Boolean(default=True)
    booking_url = fields.Char("Full URL", compute="_compute_url")

    # Helper Fields
    is_current_user = fields.Boolean(compute='_compute_permissions')
    is_admin = fields.Boolean(compute='_compute_permissions')

    @api.depends('user_id')
    def _compute_permissions(self):
        # REVISI: Cek Group Meeting Manager, BUKAN System Administrator
        # Sebelumnya: has_group('base.group_system') -> Salah sasaran
        is_admin_user = self.env.user.has_group('meeting_rooms.group_meeting_manager')
        
        for rec in self:
            rec.is_current_user = (rec.user_id == self.env.user)
            rec.is_admin = is_admin_user

    def _generate_token(self):
        return uuid.uuid4().hex[:12]

    @api.depends('token')
    def _compute_url(self):
        base_url = self.env['ir.config_parameter'].sudo().get_param('web.base.url')
        for rec in self:
            if rec.token:
                rec.booking_url = url_join(base_url, f"/book/{rec.token}")
            else:
                rec.booking_url = False

    def action_regenerate_token(self):
        for rec in self:
            rec.token = uuid.uuid4().hex[:12]

    @api.model
    def action_open_my_link(self):
        my_link = self.search([('user_id', '=', self.env.user.id)], limit=1)
        if not my_link:
            my_link = self.create({
                'name': f"{self.env.user.name}'s Booking Link",
                'user_id': self.env.user.id
            })
        return {
            'type': 'ir.actions.act_window',
            'name': 'Edit My Booking Link',
            'res_model': 'meeting.booking.link',
            'res_id': my_link.id,
            'view_mode': 'form',
            'target': 'current',
        }

    def init(self):
        """
        Fungsi ini dipanggil otomatis saat Module di-Upgrade.
        Gunanya untuk memaksa update field has_booking_link di ResUsers.
        """
        all_links = self.search([])
        users_with_links = all_links.mapped('user_id')
        
        if users_with_links:
            users_with_links.write({'has_booking_link': True})